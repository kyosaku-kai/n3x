# n3x GitLab CI/CD Pipeline
#
# Pipeline Architecture (Plan 021)
# ================================
#
# Design Principle: Nix orchestrates WHAT to build; kas-isar handles HOW.
# Local/CI parity: Same kas YAML files, same kas-isar version, same BitBake.
#
# Stages:
#   validate     - Nix evaluation, formatting (any runner with nix tag)
#   build-images - Debian backend .wic builds (kas-isar image directly, NO Nix)
#   build-nix    - Nix derivations, docs (EC2 with nix)
#   test-unit    - Non-VM tests (EC2 with nix)
#   test-vm      - NixOS/Debian backend VM tests (on-prem with nix + kvm)
#   release      - Artifact publishing (any runner with nix)
#
# Runner Tags:
#   nix        - Nix 2.18+ with flakes enabled
#   kvm        - /dev/kvm access for VM tests
#   large-disk - 100GB+ scratch space for Debian backend builds
#   aarch64    - Native ARM64 (future)
#
# Runner Profiles:
#   validator     - [nix] - Any runner, validation only
#   debian-builder - [large-disk] - EC2 Debian backend builds (uses kas-isar image)
#   vm-tester     - [nix, kvm] - On-prem VM tests
#   full          - [nix, kvm, large-disk] - All capabilities

stages:
  - validate      # Nix evaluation, formatting (any runner)
  - build-images  # Debian backend builds (kas-isar image, no Nix)
  - build-nix     # Nix derivations (EC2)
  - test-unit     # Unit tests, no VMs (EC2)
  - test-vm       # VM tests (on-prem/metal with KVM)
  - release       # Artifact publishing

# =============================================================================
# GLOBAL CONFIGURATION
# =============================================================================

variables:
  # Nix flakes configuration (for validate, test-vm stages)
  NIX_CONFIG: "experimental-features = nix-command flakes"
  # Reduce build log verbosity
  NIX_BUILD_FLAGS: "--no-link"
  # ISAR cache paths (for large-disk runners in build-images stage)
  DL_DIR: /scratch/yocto/downloads
  SSTATE_DIR: /scratch/yocto/sstate

workflow:
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on main/master branches
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Run on feature branches (manual for expensive jobs)
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# JOB TEMPLATES (Hidden Jobs)
# =============================================================================

# Template: Base Nix configuration (all runners)
.nix-base:
  image: nixos/nix:latest
  before_script:
    - nix --version
    - echo "accept-flake-config = true" >> /etc/nix/nix.conf
  tags:
    - nix

# Template: Validator profile (any nix runner)
.validator:
  extends: .nix-base
  # No additional tags - runs on any nix-enabled runner

# Template: Debian backend builder profile (kas-isar image directly, no Nix)
# This uses the standard kas-in-GitLab pattern from Siemens projects.
# Nix remains the orchestrator (validates configs at eval time) but
# build-images stage runs kas-isar directly for efficiency.
.debian-builder:
  # Use kas-isar image directly - GitLab runs job inside this container
  # Version pinned to match flake.nix:249 for local/CI parity
  image: ghcr.io/siemens/kas/kas-isar:5.1
  tags:
    - large-disk
  variables:
    DL_DIR: /scratch/yocto/downloads
    SSTATE_DIR: /scratch/yocto/sstate
  before_script:
    - kas --version
    - echo "Using SSTATE_DIR=$SSTATE_DIR"
    - echo "Using DL_DIR=$DL_DIR"
    - cd backends/debian

# Template: VM tester profile (on-prem with KVM)
.vm-tester:
  extends: .nix-base
  tags:
    - nix
    - kvm
  before_script:
    - nix --version
    - echo "accept-flake-config = true" >> /etc/nix/nix.conf
    - test -c /dev/kvm && echo "KVM available" || (echo "ERROR: /dev/kvm not found" && exit 1)

# Template: Full profile (on-prem with all capabilities)
.full-runner:
  extends: .nix-base
  tags:
    - nix
    - podman
    - kvm
    - large-disk

# =============================================================================
# STAGE: validate
# Purpose: Quick checks that run on any nix-enabled runner
# Runner: validator profile (nix tag only)
# =============================================================================

validate:flake-check:
  stage: validate
  extends: .validator
  script:
    - echo "Validating flake evaluation..."
    - nix flake check --no-build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:nixfmt:
  stage: validate
  extends: .validator
  script:
    - echo "Checking Nix formatting..."
    - nix build '.#checks.x86_64-linux.nixpkgs-fmt' --print-build-logs
  allow_failure: true  # Formatting is advisory, not blocking
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

validate:debian-package-parity:
  stage: validate
  extends: .validator
  script:
    - echo "Verifying Debian package parity..."
    - nix build '.#checks.x86_64-linux.debian-package-parity' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# STAGE: build-images
# Purpose: Build Debian backend .wic images
# Runner profiles:
#   Docker-based: debian-builder (kas-isar:5.1 image, shared runners)
#   Self-managed: debian-builder-nix (NixOS shell executor, nix devshell)
#
# Docker jobs use `kas build` inside the kas-isar container.
# Self-managed jobs use `nix develop .#debian -c kas-build` with podman.
# Both produce identical .wic images from the same kas config chains.
# =============================================================================

# Template for Debian backend image builds
.debian-build:
  stage: build-images
  extends: .debian-builder
  timeout: 60 minutes
  artifacts:
    paths:
      - build/tmp/deploy/images/
    expire_in: 1 week
  rules:
    # Build on MR to main/master
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master")
    # Build on main/master commits
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Manual on feature branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# Individual Debian backend image builds
# Each job uses `kas build` directly - same kas config chains as local workflow.
# Local equivalent: nix develop .#debian -c kas-build <same-kas-chain>
build:debian:server-1-simple:
  extends: .debian-build
  script:
    - echo "Building Debian backend k3s-server-1 (simple network)..."
    - kas build kas/base.yml:kas/machine/qemu-amd64.yml:kas/packages/k3s-core.yml:kas/packages/debug.yml:kas/image/k3s-server.yml:kas/boot/grub.yml:kas/test-k3s-overlay.yml:kas/network/simple.yml:kas/node/server-1.yml
  variables:
    IMAGE_ROLE: server
    NODE_ID: "1"
    NETWORK_PROFILE: simple

build:debian:server-2-simple:
  extends: .debian-build
  script:
    - echo "Building Debian backend k3s-server-2 (simple network)..."
    - kas build kas/base.yml:kas/machine/qemu-amd64.yml:kas/packages/k3s-core.yml:kas/packages/debug.yml:kas/image/k3s-server.yml:kas/boot/grub.yml:kas/test-k3s-overlay.yml:kas/network/simple.yml:kas/node/server-2.yml
  variables:
    IMAGE_ROLE: server
    NODE_ID: "2"
    NETWORK_PROFILE: simple

build:debian:agent-1-simple:
  extends: .debian-build
  script:
    - echo "Building Debian backend k3s-agent-1 (simple network)..."
    - kas build kas/base.yml:kas/machine/qemu-amd64.yml:kas/packages/k3s-core.yml:kas/packages/debug.yml:kas/image/k3s-agent.yml:kas/boot/grub.yml:kas/test-k3s-overlay.yml:kas/network/simple.yml:kas/node/agent-1.yml
  variables:
    IMAGE_ROLE: agent
    NODE_ID: "1"
    NETWORK_PROFILE: simple

# --- Self-Managed Debian Backend Builds (NixOS shell executor) ---
#
# These jobs run on self-managed NixOS runners with shell executors.
# Unlike the Docker-based .debian-builder jobs above, these use the Nix
# devshell to invoke kas-container with podman:
#   nix develop .#debian -c kas-build <kas-config-chain>
#
# Benefits on self-managed runners:
#   - apt-cacher-ng proxy caches Debian packages locally
#   - Persistent Yocto DL_DIR/SSTATE_DIR across builds
#   - Harmonia serves built Nix store paths to other nodes
#
# The apt-cacher-ng overlay (kas/opt/apt-cacher-ng.yml) routes apt
# traffic through localhost:3142. kas-container uses --network=host,
# so the container shares the host's network namespace.

# Template: Debian backend builder on self-managed NixOS runners
.debian-builder-nix:
  stage: build-images
  extends: .nix-base
  tags:
    - nix
    - large-disk
    - x86_64
  timeout: 90 minutes
  before_script:
    - nix --version
    - echo "accept-flake-config = true" >> /etc/nix/nix.conf
    - podman --version
    - echo "apt-cacher-ng status:"
    - curl -sf http://localhost:3142/acng-report.html > /dev/null && echo "  proxy available" || echo "  proxy not available (builds will use direct upstream)"
  artifacts:
    paths:
      - backends/debian/build/tmp/deploy/images/
    expire_in: 1 week
  rules:
    # Build on MR to main/master
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master")
    # Build on main/master commits
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Manual on feature branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# Self-managed Debian backend image builds
# Uses nix develop to enter the Debian backend build environment, then kas-build
# (WSL-safe wrapper around kas-container --isar build).
# apt-cacher-ng overlay included for local apt proxy caching.
build:debian-nix:server-1-simple:
  extends: .debian-builder-nix
  script:
    - echo "Building Debian backend k3s-server-1 (simple, self-managed runner)..."
    - >-
      nix develop '.#debian' -c kas-build
      backends/debian/kas/base.yml:backends/debian/kas/machine/qemu-amd64.yml:backends/debian/kas/packages/k3s-core.yml:backends/debian/kas/packages/debug.yml:backends/debian/kas/image/k3s-server.yml:backends/debian/kas/boot/grub.yml:backends/debian/kas/test-k3s-overlay.yml:backends/debian/kas/network/simple.yml:backends/debian/kas/node/server-1.yml:backends/debian/kas/opt/apt-cacher-ng.yml

build:debian-nix:server-2-simple:
  extends: .debian-builder-nix
  script:
    - echo "Building Debian backend k3s-server-2 (simple, self-managed runner)..."
    - >-
      nix develop '.#debian' -c kas-build
      backends/debian/kas/base.yml:backends/debian/kas/machine/qemu-amd64.yml:backends/debian/kas/packages/k3s-core.yml:backends/debian/kas/packages/debug.yml:backends/debian/kas/image/k3s-server.yml:backends/debian/kas/boot/grub.yml:backends/debian/kas/test-k3s-overlay.yml:backends/debian/kas/network/simple.yml:backends/debian/kas/node/server-2.yml:backends/debian/kas/opt/apt-cacher-ng.yml

build:debian-nix:agent-1-simple:
  extends: .debian-builder-nix
  script:
    - echo "Building Debian backend k3s-agent-1 (simple, self-managed runner)..."
    - >-
      nix develop '.#debian' -c kas-build
      backends/debian/kas/base.yml:backends/debian/kas/machine/qemu-amd64.yml:backends/debian/kas/packages/k3s-core.yml:backends/debian/kas/packages/debug.yml:backends/debian/kas/image/k3s-agent.yml:backends/debian/kas/boot/grub.yml:backends/debian/kas/test-k3s-overlay.yml:backends/debian/kas/network/simple.yml:backends/debian/kas/node/agent-1.yml:backends/debian/kas/opt/apt-cacher-ng.yml

# =============================================================================
# STAGE: build-nix
# Purpose: Build Nix derivations (docs, Debian packages)
# Runner: validator (docs), self-managed x86_64/aarch64 (packages)
# =============================================================================

build:nix:docs:
  stage: build-nix
  extends: .validator
  script:
    - echo "Building documentation..."
    - nix build '.#packages.x86_64-linux.docs' --print-build-logs
  artifacts:
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# --- Debian Package Builds (self-managed runners) ---
#
# Packages in packages/ are built as .deb files via Nix derivations.
# These jobs target self-managed runners with Harmonia binary cache,
# so built paths are automatically available to other nodes via
# HTTP substitution.
#
# Built .deb artifacts are stored for downstream consumption by
# Debian backend image assembly (Task 19) and JFrog publishing (Task 21).

# Template for Debian package builds
.deb-builder:
  stage: build-nix
  extends: .nix-base
  timeout: 15 minutes
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week
  rules:
    # Build on MRs when package sources change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - backends/debian/packages/**/*
        - flake.nix
        - flake.lock
    # Build on main/master when package sources change
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      changes:
        - backends/debian/packages/**/*
        - flake.nix
        - flake.lock
    # Manual on feature branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

build:deb:k3s:
  extends: .deb-builder
  tags:
    - nix
    - x86_64
  script:
    - echo "Building k3s .deb package (amd64)..."
    - nix build '.#packages.x86_64-linux.k3s' --print-build-logs
    - mkdir -p artifacts
    - cp result/*.deb artifacts/
    - echo "Package contents:"
    - dpkg-deb --info artifacts/k3s_*.deb

build:deb:k3s-system-config:
  extends: .deb-builder
  tags:
    - nix
    - x86_64
  script:
    - echo "Building k3s-system-config .deb package (all)..."
    - nix build '.#packages.x86_64-linux.k3s-system-config' --print-build-logs
    - mkdir -p artifacts
    - cp result/*.deb artifacts/
    - echo "Package contents:"
    - dpkg-deb --info artifacts/k3s-system-config_*.deb

build:deb:k3s-arm64:
  extends: .deb-builder
  tags:
    - nix
    - aarch64
  script:
    - echo "Building k3s .deb package (arm64)..."
    - nix build '.#packages.aarch64-linux.k3s' --print-build-logs
    - mkdir -p artifacts
    - cp result/*.deb artifacts/
    - echo "Package contents:"
    - dpkg-deb --info artifacts/k3s_*.deb

# =============================================================================
# STAGE: test-unit
# Purpose: Non-VM tests that can run on standard EC2
# Runner: validator profile (nix tag only)
# =============================================================================

test:unit:artifact-validation:
  stage: test-unit
  extends: .validator
  script:
    - echo "Validating Debian artifact hashes..."
    - nix build '.#checks.x86_64-linux.debian-artifact-validation' --print-build-logs || echo "Debian artifacts not available - skipping"
  allow_failure: true  # Only passes when artifacts are staged
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# STAGE: test-vm
# Purpose: VM-based integration tests requiring /dev/kvm
# Runner profiles:
#   vm-tester:       [nix, kvm] - Any runner with KVM (backward compatible)
#   vm-tester-onprem: [nix, kvm, on-prem] - Self-managed on-prem runner
#
# Artifact Transfer Architecture (self-managed):
#   EC2 runners build Debian backend images → stored in Nix store → served by Harmonia
#   On-prem runner runs VM tests → Nix fetches images via HTTP substituter
#   No GitLab artifact transfer needed — Nix content-addressing handles it.
#   Substituters configured at system level by n3x.nix-config module.
#
# CI Practical Categories (from Plan 021 Task A3):
#   Always (<30s)    - Run on every commit
#   Primary (<3min)  - Run on every MR
#   Secondary (<5min)- Run on MR + label or scheduled
#   Nightly (>5min)  - Scheduled pipeline only
# =============================================================================

# Template: VM tester on self-managed on-prem runner
# Uses system-level Nix substituters (configured by n3x.nix-config module)
# to fetch Debian backend image derivations built on EC2 runners via Harmonia.
.vm-tester-onprem:
  extends: .nix-base
  tags:
    - nix
    - kvm
    - on-prem
  before_script:
    - nix --version
    - echo "accept-flake-config = true" >> /etc/nix/nix.conf
    - test -c /dev/kvm && echo "KVM available" || (echo "ERROR: /dev/kvm not found" && exit 1)
    # Verify substituter connectivity to EC2 caches
    - |
      echo "Checking Harmonia substituter connectivity..."
      for cache in $(nix show-config 2>/dev/null | grep '^substituters' | tr ' ' '\n' | grep 'n3x.internal'); do
        curl -sf --max-time 5 "$cache/nix-cache-info" > /dev/null 2>&1 \
          && echo "  $cache: reachable" \
          || echo "  $cache: unreachable (will build locally)"
      done

# --- NixOS Smoke Tests (Always - <30s each) ---

test:nixos:smoke-vm-boot:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running NixOS smoke test: VM boot..."
    - nix build '.#checks.x86_64-linux.smoke-vm-boot' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:nixos:smoke-two-vm-network:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running NixOS smoke test: two-VM network..."
    - nix build '.#checks.x86_64-linux.smoke-two-vm-network' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:nixos:smoke-k3s-service:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running NixOS smoke test: k3s service starts..."
    - nix build '.#checks.x86_64-linux.smoke-k3s-service-starts' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# --- NixOS Primary Cluster Tests (Primary - <3min each) ---

test:nixos:cluster-simple:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s cluster test: simple network..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-simple' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:nixos:cluster-vlans:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s cluster test: VLANs..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-vlans' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:nixos:cluster-bonding-vlans:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s cluster test: bonding + VLANs..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-bonding-vlans' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:nixos:cluster-dhcp-simple:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s cluster test: DHCP simple..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-dhcp-simple' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:nixos:storage:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s storage test..."
    - nix build '.#checks.x86_64-linux.k3s-storage' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# --- NixOS Secondary Tests (Secondary - <5min, MR + label or manual) ---

test:nixos:cluster-simple-systemd-boot:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s cluster test: simple (systemd-boot)..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-simple-systemd-boot' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /test::full/
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

test:nixos:network:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running NixOS k3s network test..."
    - nix build '.#checks.x86_64-linux.k3s-network' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /test::full/
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

test:nixos:network-constraints:
  stage: test-vm
  extends: .vm-tester
  timeout: 15 minutes
  script:
    - echo "Running NixOS k3s network constraints test..."
    - nix build '.#checks.x86_64-linux.k3s-network-constraints' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /test::full/
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# --- NixOS Nightly Tests (Nightly - >5min, scheduled only) ---

test:nixos:network-resilience:
  stage: test-vm
  extends: .vm-tester
  timeout: 20 minutes
  script:
    - echo "Running NixOS network resilience test..."
    - nix build '.#checks.x86_64-linux.network-resilience' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

test:nixos:emulation-vm-boots:
  stage: test-vm
  extends: .vm-tester
  timeout: 20 minutes
  script:
    - echo "Running NixOS emulation VM boot test..."
    - nix build '.#checks.x86_64-linux.emulation-vm-boots' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# --- Debian Backend Smoke Tests (Always - <30s each) ---

test:debian:vm-boot:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  needs:
    - job: build:debian:server-1-simple
      optional: true
    - job: build:debian-nix:server-1-simple
      optional: true
  script:
    - echo "Running Debian backend smoke test: VM boot..."
    # Stage artifact if available from build job
    - |
      if [ -d "build/tmp/deploy/images/" ]; then
        echo "Staging Debian backend artifacts from build job..."
        # TODO: nix-store --add-fixed for FODs
      fi
    - nix build '.#checks.x86_64-linux.debian-vm-boot' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:two-vm-network:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running Debian backend smoke test: two-VM network..."
    - nix build '.#checks.x86_64-linux.debian-two-vm-network' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:k3s-service:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running Debian backend smoke test: k3s service starts..."
    - nix build '.#checks.x86_64-linux.debian-k3s-service' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# --- Debian Backend Primary Cluster Tests (Primary - <3min each) ---

test:debian:cluster-simple:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  needs:
    - job: build:debian:server-1-simple
      optional: true
    - job: build:debian:server-2-simple
      optional: true
    - job: build:debian:agent-1-simple
      optional: true
    - job: build:debian-nix:server-1-simple
      optional: true
    - job: build:debian-nix:server-2-simple
      optional: true
    - job: build:debian-nix:agent-1-simple
      optional: true
  script:
    - echo "Running Debian backend k3s cluster test: simple network..."
    - nix build '.#checks.x86_64-linux.debian-k3s-cluster-simple' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:cluster-vlans:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running Debian backend k3s cluster test: VLANs..."
    - nix build '.#checks.x86_64-linux.debian-k3s-cluster-vlans' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:cluster-bonding-vlans:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running Debian backend k3s cluster test: bonding + VLANs..."
    - nix build '.#checks.x86_64-linux.debian-k3s-cluster-bonding-vlans' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:cluster-dhcp-simple:
  stage: test-vm
  extends: .vm-tester
  timeout: 10 minutes
  script:
    - echo "Running Debian backend k3s cluster test: DHCP simple..."
    - nix build '.#checks.x86_64-linux.debian-k3s-cluster-dhcp-simple' --print-build-logs
  artifacts:
    when: always
    paths:
      - result/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# --- Debian Backend SWUpdate Tests (Primary - <1min each) ---

test:debian:swupdate-bundle:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running Debian backend SWUpdate bundle validation..."
    - nix build '.#checks.x86_64-linux.test-swupdate-bundle-validation' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:swupdate-apply:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running Debian backend SWUpdate apply test..."
    - nix build '.#checks.x86_64-linux.test-swupdate-apply' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

test:debian:swupdate-network-ota:
  stage: test-vm
  extends: .vm-tester
  timeout: 5 minutes
  script:
    - echo "Running Debian backend SWUpdate network OTA test..."
    - nix build '.#checks.x86_64-linux.test-swupdate-network-ota' --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# =============================================================================
# STAGE: release
# Purpose: Publish artifacts, update hashes
# Runner: validator profile (nix tag only)
# =============================================================================

release:publish-docs:
  stage: release
  extends: .validator
  needs:
    - build:nix:docs
  script:
    - echo "Publishing documentation..."
    # TODO: Deploy docs to pages or artifact storage
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# =============================================================================
# SCHEDULED PIPELINES
# =============================================================================

# Full test suite - runs all checks (scheduled nightly)
# On self-managed infrastructure, uses on-prem runner with KVM.
# Harmonia substituters provide EC2-built derivations automatically.
scheduled:full-suite:
  stage: test-vm
  extends: .vm-tester
  timeout: 90 minutes
  script:
    - echo "Running full flake check..."
    - nix flake check --print-build-logs
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
