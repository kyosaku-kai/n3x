# n3x GitLab CI/CD Pipeline
#
# This pipeline runs nixosTest integration tests for the k3s cluster.
# IMPORTANT: Tests require KVM access for VM-based integration tests.
#
# Runner Requirements:
# - Nix installed with flakes enabled
# - /dev/kvm access for hardware-accelerated VMs
# - For self-hosted runners: NixOS with KVM module enabled
#
# Usage:
# - CI runs on all branches and merge requests
# - Full test suite runs on main/master branches
# - Quick validation runs on feature branches
# - Manual trigger available for full test suite on any branch

stages:
  - validate
  - test
  - integration

variables:
  # Use Nix flakes
  NIX_CONFIG: "experimental-features = nix-command flakes"
  # Reduce build log verbosity (still shows errors)
  NIX_BUILD_FLAGS: "--no-link"

# Base configuration for Nix-based jobs
.nix-base:
  image: nixos/nix:latest
  before_script:
    - nix --version
    # Trust the flake (required for checks to run)
    - echo "accept-flake-config = true" >> /etc/nix/nix.conf
  cache:
    key: nix-store-${CI_COMMIT_REF_SLUG}
    paths:
      - /nix/store

# Base configuration for KVM-enabled tests
.kvm-test:
  extends: .nix-base
  tags:
    - kvm  # Runner must have /dev/kvm access
  rules:
    # Always run on main branch
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Manual trigger for other branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# =============================================================================
# VALIDATION STAGE
# =============================================================================

# Quick validation - runs on all commits
flake-check:
  stage: validate
  extends: .nix-base
  script:
    - echo "Validating flake..."
    - nix flake check --no-build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# Nix formatting check
format-check:
  stage: validate
  extends: .nix-base
  script:
    - echo "Checking Nix formatting..."
    - nix build '.#checks.x86_64-linux.nixpkgs-fmt' --print-build-logs
  allow_failure: true  # Formatting issues shouldn't block CI
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# =============================================================================
# TEST STAGE - Individual Test Jobs
# =============================================================================

# K3s cluster formation test
# Tests: 2 servers + 1 agent cluster formation, node joining, workload deployment
k3s-cluster-formation:
  stage: test
  extends: .kvm-test
  timeout: 30 minutes
  script:
    - echo "Running k3s cluster formation test..."
    - nix build '.#checks.x86_64-linux.k3s-cluster-formation' --print-build-logs
  artifacts:
    when: always
    paths:
      - result
    expire_in: 1 week

# K3s storage infrastructure test
# Tests: Storage prerequisites, local-path PVC provisioning, StatefulSet volumes
k3s-storage:
  stage: test
  extends: .kvm-test
  timeout: 30 minutes
  script:
    - echo "Running k3s storage test..."
    - nix build '.#checks.x86_64-linux.k3s-storage' --print-build-logs
  artifacts:
    when: always
    paths:
      - result
    expire_in: 1 week

# K3s networking validation test
# Tests: CoreDNS, flannel VXLAN, service discovery, pod network connectivity
k3s-network:
  stage: test
  extends: .kvm-test
  timeout: 30 minutes
  script:
    - echo "Running k3s network test..."
    - nix build '.#checks.x86_64-linux.k3s-network' --print-build-logs
  artifacts:
    when: always
    paths:
      - result
    expire_in: 1 week

# K3s network constraints test
# Tests: Cluster behavior under degraded network (latency, packet loss, bandwidth limits)
k3s-network-constraints:
  stage: test
  extends: .kvm-test
  timeout: 45 minutes  # Network constraint tests take longer
  script:
    - echo "Running k3s network constraints test..."
    - nix build '.#checks.x86_64-linux.k3s-network-constraints' --print-build-logs
  artifacts:
    when: always
    paths:
      - result
    expire_in: 1 week

# =============================================================================
# INTEGRATION STAGE - Full Test Suite
# =============================================================================

# Emulation VM boots test
# Tests: Outer VM with libvirtd, OVS, dnsmasq, and inner VM definitions
emulation-vm-boots:
  stage: integration
  extends: .kvm-test
  timeout: 20 minutes
  script:
    - echo "Running emulation VM boot test..."
    - nix build '.#checks.x86_64-linux.emulation-vm-boots' --print-build-logs
  rules:
    # Only run on main branch by default (resource-intensive)
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Manual trigger for other branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# Network resilience test (vsim infrastructure)
# Tests: TC profile infrastructure for network constraint scenarios
network-resilience:
  stage: integration
  extends: .kvm-test
  timeout: 20 minutes
  script:
    - echo "Running network resilience test..."
    - nix build '.#checks.x86_64-linux.network-resilience' --print-build-logs
  rules:
    # Only run on main branch by default (resource-intensive)
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    # Manual trigger for other branches
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true

# Full test suite - runs all checks
# Use this for comprehensive validation before releases
full-test-suite:
  stage: integration
  extends: .kvm-test
  timeout: 90 minutes
  script:
    - echo "Running full flake check..."
    - nix flake check --print-build-logs
  rules:
    # Manual trigger only - very resource intensive
    - if: $CI_COMMIT_BRANCH
      when: manual
      allow_failure: true
