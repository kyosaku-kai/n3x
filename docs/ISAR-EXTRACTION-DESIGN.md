# ISAR Extraction Design: n3x → n3x

> **Superseded**: Active extraction tracking has moved to [n3x-extraction-manifest.md](n3x-extraction-manifest.md).
> This document is retained as historical reference for the original extraction design rationale.

**Status**: Superseded (see manifest for active tracking)
**Created**: 2026-02-08

This document captures the repository structure transformation from `n3x/backends/debian/` to the standalone `n3x` repository.

## Kas/ISAR Super-Project Pattern

A kas-based ISAR project leverages upstream content at build time:

```
┌─────────────────────────────────────────────────────────────────────┐
│                        UPSTREAM (git fetched)                        │
│  github.com/ilbers/isar.git                                          │
│  ├── meta/           # Core ISAR infrastructure                      │
│  └── meta-isar/      # Sample layer with stock machines & images     │
│      ├── conf/machine/qemuamd64.conf, qemuarm64.conf, rpi-*, etc.   │
│      └── recipes-core/images/isar-image-base.bb, isar-image-debug.bb│
└─────────────────────────────────────────────────────────────────────┘
                              ↓ referenced via kas/base.yml
┌─────────────────────────────────────────────────────────────────────┐
│                    OUR PROJECT (n3x repo)                       │
│  kas/*.yml           # Overlay configs (compose layers)              │
│  meta-n3x/      # Our custom layer (machines, recipes, images)  │
└─────────────────────────────────────────────────────────────────────┘
```

**Key insight**: We don't copy upstream content. `kas/base.yml` fetches it at build time.

---

## Annotation Legend

| Tag | Meaning |
|-----|---------|
| `[CUSTOM]` | We created this, extract to n3x |
| `[CUSTOM kas]` | Our kas overlay referencing upstream |
| `[CUSTOM LAYER]` | Our meta layer |
| `[CUSTOM BSP]` | Board Support Package we maintain |
| `[CUSTOM APP]` | Application recipe - will become Debian pkg (F3) |
| `[CUSTOM TEST]` | Testing infrastructure |
| `[N3X-SYNCED]` | Generated by n3x, synced via interface |
| `[N3X-ONLY]` | n3x-specific, DO NOT extract |
| `[STOCK]` | From upstream isar (not in our tree, fetched at build time) |
| `[PLACEHOLDER]` | Empty directory for future use |
| `[CREATE]` | New file to create during extraction |
| `[TO CREATE]` | Missing file that n3x sync will generate |

---

## Before: Current n3x/backends/debian/ Structure

```
backends/debian/
│
├── README.md                              [CUSTOM] Our documentation
├── debian-artifacts.nix                   [N3X-ONLY] Nix integration - DO NOT EXTRACT
├── versions.nix                           [N3X-ONLY] Nix pinning - DO NOT EXTRACT
│
├── kas/
│   ├── base.yml                           [CUSTOM] Fetches upstream isar, adds meta-n3x
│   │
│   ├── boot/
│   │   ├── grub.yml                       [CUSTOM] GRUB bootloader + kernel cmdline
│   │   └── systemd-boot.yml               [CUSTOM] Alternative bootloader
│   │
│   ├── feature/
│   │   └── swupdate.yml                   [CUSTOM] SWUpdate A/B updates
│   │
│   ├── image/
│   │   ├── k3s-agent.yml                  [CUSTOM] Agent image target
│   │   ├── k3s-server.yml                 [CUSTOM] Server image target
│   │   └── base.yml               [CUSTOM] Base image target
│   │
│   ├── machine/
│   │   ├── qemu-amd64.yml                 [CUSTOM kas] → uses STOCK machine (qemuamd64)
│   │   ├── qemu-arm64.yml                 [CUSTOM kas] → uses STOCK machine (qemuarm64)
│   │   ├── qemu-amd64-v3c18i.yml          [CUSTOM] QEMU emulating our custom hw
│   │   ├── qemu-arm64-orin.yml            [CUSTOM] QEMU emulating Jetson
│   │   ├── amd-v3c18i.yml                 [CUSTOM kas] → uses CUSTOM machine
│   │   └── jetson-orin-nano.yml           [CUSTOM kas] → uses CUSTOM machine
│   │
│   ├── network/                           [N3X-SYNCED] Generated by n3x
│   │   ├── simple.yml
│   │   ├── vlans.yml
│   │   ├── bonding-vlans.yml
│   │   └── dhcp-simple.yml
│   │
│   ├── node/                              [N3X-SYNCED] Generated by n3x
│   │   ├── server-1.yml                   (agent-1, agent-2 missing - need creation)
│   │   └── server-2.yml
│   │
│   ├── opt/
│   │   ├── debug.yml                      [CUSTOM] Developer conveniences
│   │   ├── sdk.yml                        [CUSTOM] SDK generation
│   │   └── wsl-fix.yml                    [N3X-ONLY] WSL workaround - DO NOT EXTRACT
│   │
│   ├── packages/
│   │   ├── debug.yml                      [CUSTOM] Debug packages overlay
│   │   └── k3s-core.yml                   [CUSTOM] K3s runtime dependencies
│   │
│   ├── test-k3s-overlay.yml               [CUSTOM] Test image config
│   └── test-overlay.yml                   [CUSTOM] Generic test overlay
│
├── meta-n3x/                         [CUSTOM LAYER] Our BitBake layer
│   │
│   ├── classes/
│   │   └── nvidia-l4t-cross-build.bbclass [CUSTOM] Jetson cross-build support
│   │
│   ├── conf/
│   │   ├── layer.conf                     [CUSTOM] Layer registration
│   │   ├── machine/
│   │   │   ├── amd-v3c18i.conf            [CUSTOM] Our AMD V3000 board
│   │   │   └── jetson-orin-nano.conf      [CUSTOM] Our Jetson board
│   │   └── multiconfig/                   [CUSTOM] Multiconfig for custom machines
│   │
│   ├── recipes-bsp/
│   │   └── nvidia-l4t/                    [CUSTOM BSP] NVIDIA L4T integration
│   │       ├── nvidia-l4t-core_36.4.4.bb
│   │       └── nvidia-l4t-tools_36.4.4.bb
│   │
│   ├── recipes-core/
│   │   ├── images/                        [CUSTOM] Our image definitions
│   │   │   ├── n3x-image.inc
│   │   │   ├── n3x-image-agent.bb
│   │   │   ├── n3x-image-base.bb
│   │   │   └── n3x-image-server.bb
│   │   │
│   │   ├── k3s/                           [CUSTOM APP] → F3: Move to Debian pkg
│   │   │   ├── k3s-base.inc
│   │   │   ├── k3s-agent_1.32.0.bb
│   │   │   ├── k3s-server_1.32.0.bb
│   │   │   └── files/
│   │   │
│   │   ├── k3s-system-config/             [CUSTOM APP] → F3: Move to Debian pkg
│   │   │   ├── k3s-system-config_1.0.bb
│   │   │   └── files/
│   │   │
│   │   └── swupdate/                      [CUSTOM] SWUpdate config
│   │       ├── swupdate-config_1.0.bb
│   │       └── files/
│   │
│   ├── recipes-kernel/                    [PLACEHOLDER] For future custom kernel work
│   │
│   ├── recipes-support/
│   │   ├── gptfdisk/                      [CUSTOM] Upstream-quality patch for sync() bug
│   │   │   └── files/0001-diskio-unix-remove-global-sync-to-fix-WSL2-hang.patch
│   │   ├── gptfdisk-wsl-fix/              [CUSTOM] LD_PRELOAD workaround
│   │   │   ├── gptfdisk-wsl-fix_1.0.bb
│   │   │   └── files/
│   │   └── systemd-networkd-config/       [N3X-SYNCED]
│   │       ├── systemd-networkd-config_1.0.bb  [CUSTOM] Recipe (stays)
│   │       └── files/                          [N3X-SYNCED] Network configs
│   │           ├── simple/{server,agent}-*/
│   │           ├── vlans/{server,agent}-*/
│   │           ├── bonding-vlans/{server,agent}-*/
│   │           └── dhcp-simple/{server,agent}-*/
│   │
│   ├── recipes-testing/
│   │   └── nixos-test-backdoor/           [CUSTOM TEST] → F3: Move to Debian pkg
│   │       ├── nixos-test-backdoor_1.0.bb
│   │       └── files/
│   │
│   └── wic/                               [CUSTOM] Image layout definitions
│       ├── grub-ab.cfg
│       ├── sdimage-efi-ab.wks
│       ├── sdimage-efi-n3x.wks
│       └── sdimage-efi-systemd-boot-k3s.wks
│
├── scripts/                               [N3X-ONLY] Nix helper scripts - DO NOT EXTRACT
│   └── isar-build-all.sh
│
└── swupdate/                              [N3X-ONLY] Nix SWUpdate integration - DO NOT EXTRACT
    ├── bundle.nix
    └── default.nix
```

---

## After: Target n3x/ Repository Structure

```
n3x/                                  # Standalone repository (NEW)
│
├── README.md                              [CREATE] Build instructions, team onboarding
├── INTERFACE.md                           [CREATE] n3x relationship documentation (F2)
├── .gitlab-ci.yml                         [CREATE] CI pipeline (F6)
├── .n3x-sync/
│   └── manifest.json                      [N3X-SYNCED] Provenance tracking
│
├── kas/
│   ├── base.yml                           [CUSTOM] Fetches upstream isar, adds meta-n3x
│   │
│   ├── boot/
│   │   ├── grub.yml                       [CUSTOM] GRUB + kernel cmdline
│   │   └── systemd-boot.yml               [CUSTOM] Alternative bootloader
│   │
│   ├── feature/
│   │   └── swupdate.yml                   [CUSTOM] A/B updates
│   │
│   ├── image/
│   │   ├── k3s-agent.yml                  [CUSTOM]
│   │   ├── k3s-server.yml                 [CUSTOM]
│   │   └── base.yml               [CUSTOM]
│   │
│   ├── machine/
│   │   ├── qemu-amd64.yml                 [CUSTOM kas → STOCK machine]
│   │   ├── qemu-arm64.yml                 [CUSTOM kas → STOCK machine]
│   │   ├── qemu-amd64-v3c18i.yml          [CUSTOM]
│   │   ├── qemu-arm64-orin.yml            [CUSTOM]
│   │   ├── amd-v3c18i.yml                 [CUSTOM kas → CUSTOM machine]
│   │   └── jetson-orin-nano.yml           [CUSTOM kas → CUSTOM machine]
│   │
│   ├── network/                           [N3X-SYNCED]
│   │   ├── simple.yml
│   │   ├── vlans.yml
│   │   ├── bonding-vlans.yml
│   │   └── dhcp-simple.yml
│   │
│   ├── node/                              [N3X-SYNCED]
│   │   ├── server-1.yml
│   │   ├── server-2.yml
│   │   ├── agent-1.yml                    [TO CREATE via n3x sync]
│   │   └── agent-2.yml                    [TO CREATE via n3x sync]
│   │
│   ├── opt/
│   │   ├── debug.yml                      [CUSTOM]
│   │   └── sdk.yml                        [CUSTOM]
│   │   # NOTE: wsl-fix.yml NOT extracted (n3x-only)
│   │
│   ├── packages/
│   │   ├── debug.yml                      [CUSTOM]
│   │   └── k3s-core.yml                   [CUSTOM]
│   │
│   ├── test-k3s-overlay.yml               [CUSTOM]
│   └── test-overlay.yml                   [CUSTOM]
│
├── meta-n3x/                         [CUSTOM LAYER]
│   │
│   ├── classes/
│   │   └── nvidia-l4t-cross-build.bbclass [CUSTOM]
│   │
│   ├── conf/
│   │   ├── layer.conf                     [CUSTOM]
│   │   ├── machine/
│   │   │   ├── amd-v3c18i.conf            [CUSTOM]
│   │   │   └── jetson-orin-nano.conf      [CUSTOM]
│   │   └── multiconfig/                   [CUSTOM]
│   │
│   ├── recipes-bsp/
│   │   └── nvidia-l4t/                    [CUSTOM BSP]
│   │       ├── nvidia-l4t-core_36.4.4.bb
│   │       └── nvidia-l4t-tools_36.4.4.bb
│   │
│   ├── recipes-core/
│   │   ├── images/                        [CUSTOM]
│   │   │   ├── n3x-image.inc
│   │   │   ├── n3x-image-agent.bb
│   │   │   ├── n3x-image-base.bb
│   │   │   └── n3x-image-server.bb
│   │   │
│   │   ├── k3s/                           [CUSTOM → F3: Debian pkg]
│   │   │   ├── k3s-base.inc
│   │   │   ├── k3s-agent_1.32.0.bb
│   │   │   ├── k3s-server_1.32.0.bb
│   │   │   └── files/
│   │   │
│   │   ├── k3s-system-config/             [CUSTOM → F3: Debian pkg]
│   │   │   ├── k3s-system-config_1.0.bb
│   │   │   └── files/
│   │   │
│   │   └── swupdate/                      [CUSTOM]
│   │       ├── swupdate-config_1.0.bb
│   │       └── files/
│   │
│   ├── recipes-kernel/                    [PLACEHOLDER]
│   │   # Future: Custom kernel configs using ISAR's linux-kernel.bbclass
│   │   # Use Debian-style config fragments, not Yocto bbappend
│   │
│   ├── recipes-support/
│   │   ├── gptfdisk/                      [CUSTOM → F9: upstream to gptfdisk]
│   │   │   └── files/0001-diskio-unix-remove-global-sync-to-fix-WSL2-hang.patch
│   │   ├── gptfdisk-wsl-fix/              [CUSTOM → F9: upstream after patch accepted]
│   │   │   ├── gptfdisk-wsl-fix_1.0.bb
│   │   │   └── files/
│   │   └── systemd-networkd-config/
│   │       ├── systemd-networkd-config_1.0.bb [CUSTOM]
│   │       └── files/                     [N3X-SYNCED]
│   │           ├── simple/{server,agent}-*/
│   │           ├── vlans/{server,agent}-*/
│   │           ├── bonding-vlans/{server,agent}-*/
│   │           └── dhcp-simple/{server,agent}-*/
│   │
│   ├── recipes-testing/
│   │   └── nixos-test-backdoor/           [CUSTOM → F3: Debian pkg]
│   │       ├── nixos-test-backdoor_1.0.bb
│   │       └── files/
│   │
│   └── wic/                               [CUSTOM]
│       ├── grub-ab.cfg
│       ├── sdimage-efi-ab.wks
│       ├── sdimage-efi-n3x.wks
│       └── sdimage-efi-systemd-boot-k3s.wks
│
└── docs/
    └── BUILD.md                           [CREATE] Detailed build instructions
```

---

## Extraction Summary

### Files NOT Extracted (n3x-only)

| Path | Reason |
|------|--------|
| `debian-artifacts.nix` | Nix integration |
| `versions.nix` | Nix version pinning |
| `kas/opt/wsl-fix.yml` | n3x WSL workaround overlay |
| `scripts/` | Nix helper scripts |
| `swupdate/` | Nix SWUpdate bundle generation |

### Files to Create (don't exist yet)

| Path | Created By |
|------|------------|
| `README.md` | F5 (extraction) |
| `INTERFACE.md` | F2 (interface design) |
| `.gitlab-ci.yml` | F6 (CI) |
| `.n3x-sync/manifest.json` | n3x sync tooling |
| `kas/node/agent-1.yml` | n3x sync |
| `kas/node/agent-2.yml` | n3x sync |
| `docs/BUILD.md` | F8 (documentation) |

### Recipes → Debian Packages (F3)

| Recipe | Target Debian Package |
|--------|----------------------|
| `recipes-core/k3s/` | `k3s-server`, `k3s-agent` |
| `recipes-core/k3s-system-config/` | `k3s-system-config` |
| `recipes-testing/nixos-test-backdoor/` | `nixos-test-backdoor` |

### Upstream Contributions (F9)

| Item | Target Project |
|------|----------------|
| `gptfdisk/files/0001-*.patch` | [gptfdisk](https://sourceforge.net/projects/gptfdisk/) |
| `gptfdisk-wsl-fix/` | Remove after upstream fix available |

---

## Custom Kernel Approach (recipes-kernel/)

When custom kernel work is needed, ISAR uses **Debian-style packaging**:

```
recipes-kernel/
└── linux/
    ├── linux-custom_%.bbappend   # Extend existing kernel recipe
    └── files/
        ├── custom.cfg            # Config fragments (preferred)
        └── *.patch               # Kernel patches
```

ISAR's `linux-kernel.bbclass` generates proper Debian packages:
- `linux-image-*`
- `linux-headers-*`
- `linux-kbuild-*`
- `linux-libc-dev`

Reference: [ISAR Custom Kernel Documentation](https://github.com/ilbers/isar/blob/master/doc/custom_kernel.md)

---

## Architecture Naming Convention

| Context | Convention | Example |
|---------|------------|---------|
| Debian/dpkg | `arm64` | `DISTRO_ARCH = "arm64"` |
| ISAR machines | `arm64` | `machine: qemuarm64` |
| Nix systems | `aarch64` | `system = "aarch64-linux"` |
| QEMU binaries | `aarch64` | `qemu-system-aarch64` |

All usages in this project follow the appropriate convention for their context.
