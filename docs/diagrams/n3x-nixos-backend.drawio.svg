<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg content="&lt;mxfile host=&quot;Claude&quot; modified=&quot;2026-02-16&quot;&gt;&lt;diagram name=&quot;NixOS Backend&quot; id=&quot;nixos-1&quot;&gt;&lt;mxGraphModel dx=&quot;1400&quot; dy=&quot;1100&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;1&quot; pageScale=&quot;1&quot; pageWidth=&quot;1400&quot; pageHeight=&quot;1100&quot;&gt;&lt;root&gt;&lt;mxCell id=&quot;0&quot;/&gt;&lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&lt;mxCell id=&quot;title&quot; value=&quot;&amp;lt;b&amp;gt;n3x NixOS Backend Architecture&amp;lt;/b&amp;gt;&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=18;fontColor=#333333;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;350&quot; y=&quot;10&quot; width=&quot;700&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-section&quot; value=&quot;&amp;lt;b&amp;gt;MODULE COMPOSITION&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#f0f4ff;strokeColor=#6c8ebf;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#6c8ebf;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;50&quot; width=&quot;1380&quot; height=&quot;280&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mk-sys&quot; value=&quot;&amp;lt;b&amp;gt;mkSystem&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Physical hosts&amp;lt;br&amp;gt;Includes: hosts/&amp;amp;lt;name&amp;amp;gt;/&amp;lt;br&amp;gt;+ disko + sops-nix&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=11;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;80&quot; width=&quot;150&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mk-vm&quot; value=&quot;&amp;lt;b&amp;gt;mkVMSystem&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;VM configs&amp;lt;br&amp;gt;No hosts/ dir needed&amp;lt;br&amp;gt;+ disko + sops-nix&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=11;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;160&quot; width=&quot;150&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;plus-arrow&quot; value=&quot;+&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=20;fontColor=#6c8ebf;fontStyle=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;180&quot; y=&quot;125&quot; width=&quot;30&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-common&quot; value=&quot;&amp;lt;b&amp;gt;common/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;base.nix&amp;lt;br&amp;gt;networking.nix&amp;lt;br&amp;gt;nix-settings.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;210&quot; y=&quot;80&quot; width=&quot;130&quot; height=&quot;80&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-hardware&quot; value=&quot;&amp;lt;b&amp;gt;hardware/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;n100.nix&amp;lt;br&amp;gt;jetson-orin-nano.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;350&quot; y=&quot;80&quot; width=&quot;140&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-roles&quot; value=&quot;&amp;lt;b&amp;gt;roles/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;k3s-common.nix&amp;lt;br&amp;gt;k3s-server.nix&amp;lt;br&amp;gt;k3s-agent.nix&amp;lt;br&amp;gt;k3s-server-secure.nix&amp;lt;br&amp;gt;k3s-agent-secure.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;500&quot; y=&quot;80&quot; width=&quot;140&quot; height=&quot;100&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-network&quot; value=&quot;&amp;lt;b&amp;gt;network/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;bonding.nix&amp;lt;br&amp;gt;vlans.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;650&quot; y=&quot;80&quot; width=&quot;120&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-k8s&quot; value=&quot;&amp;lt;b&amp;gt;kubernetes/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;k3s-storage.nix&amp;lt;br&amp;gt;longhorn.nix&amp;lt;br&amp;gt;kyverno.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;780&quot; y=&quot;80&quot; width=&quot;130&quot; height=&quot;80&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-security&quot; value=&quot;&amp;lt;b&amp;gt;security/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;secrets.nix (SOPS)&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;920&quot; y=&quot;80&quot; width=&quot;130&quot; height=&quot;60&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-disko&quot; value=&quot;&amp;lt;b&amp;gt;disko/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;n100-standard.nix&amp;lt;br&amp;gt;n100-zfs.nix&amp;lt;br&amp;gt;vm-test.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1060&quot; y=&quot;80&quot; width=&quot;130&quot; height=&quot;80&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;mod-vms&quot; value=&quot;&amp;lt;b&amp;gt;vms/&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;default.nix&amp;lt;br&amp;gt;k3s-server-vm.nix&amp;lt;br&amp;gt;k3s-agent-vm.nix&amp;lt;br&amp;gt;multi-node-cluster.nix&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1200&quot; y=&quot;80&quot; width=&quot;170&quot; height=&quot;90&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;compose-example&quot; value=&quot;Example: n100-1 = mkSystem { modules = [ hardware/n100 + roles/k3s-server + network/bonding ]; }&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=10;fontColor=#555555;fontStyle=2;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;195&quot; width=&quot;700&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;compose-note&quot; value=&quot;Orthogonal selection: any Hardware × Role × Network combination produces a valid NixOS configuration&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=10;fontColor=#6c8ebf;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;215&quot; width=&quot;700&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-section&quot; value=&quot;&amp;lt;b&amp;gt;HOST CONFIGURATIONS&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#f0f4ff;strokeColor=#6c8ebf;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#6c8ebf;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;245&quot; width=&quot;1380&quot; height=&quot;80&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-n100-1&quot; value=&quot;&amp;lt;b&amp;gt;n100-1&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;x86_64 | server (init)&amp;lt;br&amp;gt;n100 + bonding&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;268&quot; width=&quot;120&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-n100-2&quot; value=&quot;&amp;lt;b&amp;gt;n100-2&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;x86_64 | server&amp;lt;br&amp;gt;n100 + bonding&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;155&quot; y=&quot;268&quot; width=&quot;120&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-n100-3&quot; value=&quot;&amp;lt;b&amp;gt;n100-3&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;x86_64 | agent&amp;lt;br&amp;gt;n100 + bonding&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;285&quot; y=&quot;268&quot; width=&quot;120&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-jetson-1&quot; value=&quot;&amp;lt;b&amp;gt;jetson-1&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;aarch64 | agent&amp;lt;br&amp;gt;orin-nano + bonding&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;415&quot; y=&quot;268&quot; width=&quot;130&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-jetson-2&quot; value=&quot;&amp;lt;b&amp;gt;jetson-2&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;aarch64 | agent&amp;lt;br&amp;gt;orin-nano + bonding&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;555&quot; y=&quot;268&quot; width=&quot;130&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-vm-server&quot; value=&quot;&amp;lt;b&amp;gt;vm-k3s-server&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;x86_64 | VM&amp;lt;br&amp;gt;standalone test&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;720&quot; y=&quot;268&quot; width=&quot;120&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-vm-agent&quot; value=&quot;&amp;lt;b&amp;gt;vm-k3s-agent&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;x86_64 | VM&amp;lt;br&amp;gt;standalone test&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;850&quot; y=&quot;268&quot; width=&quot;120&quot; height=&quot;48&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-phys-label&quot; value=&quot;Physical:&quot; style=&quot;text;html=1;align=right;verticalAlign=middle;fontSize=9;fontColor=#82b366;fontStyle=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1000&quot; y=&quot;268&quot; width=&quot;60&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-phys-desc&quot; value=&quot;mkSystem + hosts/ dir + full module stack&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=9;fontColor=#555555;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1060&quot; y=&quot;268&quot; width=&quot;300&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-vm-label&quot; value=&quot;VM:&quot; style=&quot;text;html=1;align=right;verticalAlign=middle;fontSize=9;fontColor=#6c8ebf;fontStyle=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1000&quot; y=&quot;290&quot; width=&quot;60&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;host-vm-desc&quot; value=&quot;mkVMSystem + vms/ modules only&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=9;fontColor=#555555;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1060&quot; y=&quot;290&quot; width=&quot;300&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-section&quot; value=&quot;&amp;lt;b&amp;gt;NETWORK INTEGRATION&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#fffaf0;strokeColor=#d6b656;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#d6b656;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;340&quot; width=&quot;1380&quot; height=&quot;170&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-profile&quot; value=&quot;&amp;lt;b&amp;gt;Network Profile&amp;lt;/b&amp;gt;&amp;lt;hr size=&amp;quot;1&amp;quot;&amp;gt;ipAddresses&amp;lt;br&amp;gt;interfaces&amp;lt;br&amp;gt;vlanIds&amp;lt;br&amp;gt;bondConfig&amp;lt;br&amp;gt;serverApi&amp;lt;br&amp;gt;clusterCidr / serviceCidr&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;verticalAlign=top;spacingTop=2;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;370&quot; width=&quot;160&quot; height=&quot;120&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-profiles-list&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;simple | vlans | bonding-vlans | dhcp-simple&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=9;fontColor=#9673a6;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;490&quot; width=&quot;160&quot; height=&quot;15&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-arrow1&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;net-profile&quot; target=&quot;net-mkconfig&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-mkconfig&quot; value=&quot;&amp;lt;b&amp;gt;mkNixOSConfig&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;lib/network/mk-network-config.nix&amp;lt;br&amp;gt;Transforms profile params →&amp;lt;br&amp;gt;NixOS systemd.network modules&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;250&quot; y=&quot;375&quot; width=&quot;200&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-arrow2&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;net-mkconfig&quot; target=&quot;net-output&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-output&quot; value=&quot;&amp;lt;b&amp;gt;systemd.network.*&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;.netdev units (VLANs, bonds)&amp;lt;br&amp;gt;.network units (addresses, routes)&amp;lt;br&amp;gt;Firewall rules&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;520&quot; y=&quot;375&quot; width=&quot;180&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-arrow3&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;net-profile&quot; target=&quot;net-k3sflags&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-k3sflags&quot; value=&quot;&amp;lt;b&amp;gt;mkK3sFlags&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;lib/k3s/mk-k3s-flags.nix&amp;lt;br&amp;gt;Profile → CLI flags&amp;lt;br&amp;gt;(--node-ip, --flannel-iface, ...)&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;250&quot; y=&quot;455&quot; width=&quot;200&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-arrow4&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;net-k3sflags&quot; target=&quot;net-k3sout&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-k3sout&quot; value=&quot;&amp;lt;b&amp;gt;services.k3s.extraFlags&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Per-node k3s CLI flags&amp;lt;br&amp;gt;injected into NixOS module&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;520&quot; y=&quot;455&quot; width=&quot;180&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-shared-note&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Same profile data feeds Debian backend via mkSystemdNetworkdFiles (see Debian backend diagram)&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=9;fontColor=#b85450;fontStyle=2;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;750&quot; y=&quot;415&quot; width=&quot;380&quot; height=&quot;15&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-isar-arrow&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;also used by&amp;lt;/font&amp;gt;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=1;dashed=1;dashPattern=4 4;exitX=1;exitY=0.5;exitDx=0;exitDy=0;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;net-profile&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;880&quot; y=&quot;430&quot; as=&quot;targetPoint&quot;/&gt;&lt;Array as=&quot;points&quot;&gt;&lt;mxPoint x=&quot;880&quot; y=&quot;430&quot;/&gt;&lt;/Array&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;net-isar-target&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;&amp;lt;b&amp;gt;mkSystemdNetworkdFiles&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;→ .network/.netdev files&amp;lt;br&amp;gt;→ Debian backend&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=middle;fontSize=9;align=center;dashed=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;830&quot; y=&quot;440&quot; width=&quot;160&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-section&quot; value=&quot;&amp;lt;b&amp;gt;nixosTest INTEGRATION&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#f0f4ff;strokeColor=#6c8ebf;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#6c8ebf;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;525&quot; width=&quot;1380&quot; height=&quot;175&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-builder&quot; value=&quot;&amp;lt;b&amp;gt;mkK3sClusterTest&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;tests/lib/mk-k3s-cluster-test.nix&amp;lt;br&amp;gt;Parameterized test builder&amp;lt;br&amp;gt;{ networkProfile, testName,&amp;lt;br&amp;gt;  useSystemdBoot, ... }&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;555&quot; width=&quot;200&quot; height=&quot;80&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-arrow1&quot; value=&quot;generates&quot; style=&quot;endArrow=classic;html=1;strokeColor=#6c8ebf;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;test-builder&quot; target=&quot;test-nodes&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-nodes&quot; value=&quot;&amp;lt;b&amp;gt;Test Node VMs&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;server-1, server-2, agent-1&amp;lt;br&amp;gt;Each: NixOS config + network + k3s&amp;lt;br&amp;gt;Connected via VDE switches&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;290&quot; y=&quot;555&quot; width=&quot;200&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-arrow2&quot; value=&quot;run by&quot; style=&quot;endArrow=classic;html=1;strokeColor=#6c8ebf;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;test-nodes&quot; target=&quot;test-driver&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-driver&quot; value=&quot;&amp;lt;b&amp;gt;NixOS Test Driver&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Python test script + QEMU VMs&amp;lt;br&amp;gt;Build + Test = ONE derivation&amp;lt;br&amp;gt;(no separate build/test phases)&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;strokeWidth=2;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;555&quot; y=&quot;555&quot; width=&quot;210&quot; height=&quot;70&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-arrow3&quot; value=&quot;produces&quot; style=&quot;endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;test-driver&quot; target=&quot;test-result&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-result&quot; value=&quot;&amp;lt;b&amp;gt;PASS / FAIL&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Test log + result&amp;lt;br&amp;gt;in /nix/store/...&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;830&quot; y=&quot;560&quot; width=&quot;120&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-key-insight&quot; value=&quot;&amp;lt;b&amp;gt;Key difference from Debian backend:&amp;lt;/b&amp;gt; NixOS test derivation = build + test in one step.&amp;lt;br&amp;gt;Debian backend requires separate .wic build → hash registration → test derivation.&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=9;fontColor=#b85450;fontStyle=0;spacingLeft=10;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;640&quot; width=&quot;550&quot; height=&quot;30&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-matrix&quot; value=&quot;&amp;lt;b&amp;gt;Test Matrix:&amp;lt;/b&amp;gt; Profile (4) × Boot (2) = 8 NixOS cluster tests + smoke tests (L1-L3) + specialized tests&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=9;fontColor=#555555;spacingLeft=10;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;670&quot; width=&quot;600&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;test-isar-shared&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;&amp;lt;b&amp;gt;Shared with Debian backend:&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;Debian backend tests also use NixOS test&amp;lt;br&amp;gt;driver + QEMU, but boot .wic&amp;lt;br&amp;gt;images instead of NixOS configs&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=middle;fontSize=9;align=center;dashed=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1010&quot; y=&quot;555&quot; width=&quot;170&quot; height=&quot;65&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-section&quot; value=&quot;&amp;lt;b&amp;gt;DEPLOYMENT PATHS&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#f5f5f5;strokeColor=#999999;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#999999;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;715&quot; width=&quot;1380&quot; height=&quot;125&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-src&quot; value=&quot;&amp;lt;b&amp;gt;nixosConfiguration&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Evaluated NixOS&amp;lt;br&amp;gt;system closure&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;745&quot; width=&quot;140&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-a1&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#999999;strokeWidth=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;deploy-src&quot; target=&quot;deploy-rebuild&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-rebuild&quot; value=&quot;&amp;lt;b&amp;gt;nixos-rebuild&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;switch --flake .#host&amp;lt;br&amp;gt;In-place upgrade&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;230&quot; y=&quot;740&quot; width=&quot;150&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-a2&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#999999;strokeWidth=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;deploy-src&quot; target=&quot;deploy-anywhere&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-anywhere&quot; value=&quot;&amp;lt;b&amp;gt;nixos-anywhere&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;First install: bare metal&amp;lt;br&amp;gt;Disk partitioning via disko&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;440&quot; y=&quot;740&quot; width=&quot;165&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-a3&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#999999;strokeWidth=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;deploy-src&quot; target=&quot;deploy-jetpack&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-jetpack&quot; value=&quot;&amp;lt;b&amp;gt;jetpack-nixos&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;Jetson flash via initrd&amp;lt;br&amp;gt;NVIDIA BSP + NixOS rootfs&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;660&quot; y=&quot;740&quot; width=&quot;155&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-a4&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#999999;strokeWidth=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;deploy-src&quot; target=&quot;deploy-vm&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-vm&quot; value=&quot;&amp;lt;b&amp;gt;VM Image&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;system.build.vm&amp;lt;br&amp;gt;Standalone QEMU VM&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;870&quot; y=&quot;740&quot; width=&quot;140&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-a5&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeColor=#999999;strokeWidth=1;&quot; edge=&quot;1&quot; parent=&quot;1&quot; source=&quot;deploy-src&quot; target=&quot;deploy-ami&quot;&gt;&lt;mxGeometry relative=&quot;1&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-ami&quot; value=&quot;&amp;lt;b&amp;gt;Amazon AMI&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:9px&amp;quot;&amp;gt;system.build.images.amazon&amp;lt;br&amp;gt;CI runners (infra flake)&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=10;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1060&quot; y=&quot;740&quot; width=&quot;155&quot; height=&quot;55&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;deploy-targets&quot; value=&quot;Targets: Intel N100 (x86_64) | Jetson Orin Nano (aarch64) | EC2 instances (infra flake) | Local VMs&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=9;fontColor=#555555;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;810&quot; width=&quot;700&quot; height=&quot;15&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;input-section&quot; value=&quot;&amp;lt;b&amp;gt;FLAKE INPUTS&amp;lt;/b&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=#f5f5f5;strokeColor=#999999;strokeWidth=2;verticalAlign=top;spacingTop=5;fontSize=13;fontColor=#999999;opacity=40;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;10&quot; y=&quot;855&quot; width=&quot;1380&quot; height=&quot;100&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-nixpkgs&quot; value=&quot;&amp;lt;b&amp;gt;nixpkgs&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;nixos-25.11 (fork)&amp;lt;br&amp;gt;bootDiskAdditionalSpace&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;880&quot; width=&quot;140&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-disko&quot; value=&quot;&amp;lt;b&amp;gt;disko&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Declarative disk&amp;lt;br&amp;gt;partitioning&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;175&quot; y=&quot;880&quot; width=&quot;120&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-sops&quot; value=&quot;&amp;lt;b&amp;gt;sops-nix&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Secrets management&amp;lt;br&amp;gt;age + SOPS&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;305&quot; y=&quot;880&quot; width=&quot;120&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-jetpack&quot; value=&quot;&amp;lt;b&amp;gt;jetpack-nixos&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Jetson support (fork)&amp;lt;br&amp;gt;pluggable-rootfs&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;435&quot; y=&quot;880&quot; width=&quot;130&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-anywhere&quot; value=&quot;&amp;lt;b&amp;gt;nixos-anywhere&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Bare-metal provisioning&amp;lt;br&amp;gt;SSH + kexec + disko&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;575&quot; y=&quot;880&quot; width=&quot;140&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-hardware&quot; value=&quot;&amp;lt;b&amp;gt;nixos-hardware&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Hardware profiles&amp;lt;br&amp;gt;community maintained&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;725&quot; y=&quot;880&quot; width=&quot;140&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-impermanence&quot; value=&quot;&amp;lt;b&amp;gt;impermanence&amp;lt;/b&amp;gt;&amp;lt;br&amp;gt;&amp;lt;font style=&amp;quot;font-size:8px&amp;quot;&amp;gt;Stateless root&amp;lt;br&amp;gt;(optional, unused)&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;verticalAlign=middle;fontSize=9;align=center;dashed=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;875&quot; y=&quot;880&quot; width=&quot;130&quot; height=&quot;50&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;inp-note&quot; value=&quot;Fork inputs (nixpkgs, jetpack-nixos) have upstream PRs pending. Revert to official when merged.&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=9;fontColor=#555555;fontStyle=2;spacingLeft=10;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;1020&quot; y=&quot;895&quot; width=&quot;360&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-title&quot; value=&quot;Legend:&quot; style=&quot;text;html=1;align=left;verticalAlign=middle;fontSize=10;fontColor=#333333;fontStyle=1;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;25&quot; y=&quot;970&quot; width=&quot;50&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-blue&quot; value=&quot;Nix/NixOS&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;80&quot; y=&quot;968&quot; width=&quot;80&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-green&quot; value=&quot;Hardware&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;170&quot; y=&quot;968&quot; width=&quot;80&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-yellow&quot; value=&quot;Generators&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;260&quot; y=&quot;968&quot; width=&quot;80&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-purple&quot; value=&quot;Shared Data&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;350&quot; y=&quot;968&quot; width=&quot;85&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-red&quot; value=&quot;Cross-backend&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;445&quot; y=&quot;968&quot; width=&quot;95&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;leg-gray&quot; value=&quot;Deploy/Infra&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#999999;fontSize=9;align=center;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;550&quot; y=&quot;968&quot; width=&quot;85&quot; height=&quot;22&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;crossref&quot; value=&quot;See also: n3x-architecture.drawio.svg (system overview), n3x-debian-backend.drawio.svg (Debian backend), ci-pipeline.drawio.svg (CI/CD)&quot; style=&quot;text;html=1;align=center;verticalAlign=middle;fontSize=9;fontColor=#666666;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;200&quot; y=&quot;1000&quot; width=&quot;800&quot; height=&quot;15&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;&lt;/diagram&gt;&lt;/mxfile&gt;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1400" height="1100" viewBox="0 0 1400 1100">
  <defs/>
  <g>
    <!-- Title -->
    <text x="700" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#333333">n3x NixOS Backend Architecture</text>

    <!-- MODULE COMPOSITION Section -->
    <rect x="10" y="50" width="1380" height="280" rx="10" ry="10" fill="#f0f4ff" fill-opacity="0.4" stroke="#6c8ebf" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="70" font-size="13" font-weight="bold" fill="#6c8ebf">MODULE COMPOSITION</text>

    <!-- mkSystem -->
    <rect x="25" y="80" width="150" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="100" y="100" text-anchor="middle" font-size="11" font-weight="bold" fill="#333">mkSystem</text>
    <text x="100" y="115" text-anchor="middle" font-size="9" fill="#555">Physical hosts</text>
    <text x="100" y="127" text-anchor="middle" font-size="9" fill="#555">Includes: hosts/&lt;name&gt;/</text>
    <text x="100" y="139" text-anchor="middle" font-size="9" fill="#555">+ disko + sops-nix</text>

    <!-- mkVMSystem -->
    <rect x="25" y="160" width="150" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="100" y="180" text-anchor="middle" font-size="11" font-weight="bold" fill="#333">mkVMSystem</text>
    <text x="100" y="195" text-anchor="middle" font-size="9" fill="#555">VM configs</text>
    <text x="100" y="207" text-anchor="middle" font-size="9" fill="#555">No hosts/ dir needed</text>
    <text x="100" y="219" text-anchor="middle" font-size="9" fill="#555">+ disko + sops-nix</text>

    <!-- Plus sign -->
    <text x="195" y="145" text-anchor="middle" font-size="20" font-weight="bold" fill="#6c8ebf">+</text>

    <!-- common/ -->
    <rect x="210" y="80" width="130" height="80" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="275" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">common/</text>
    <line x1="220" y1="103" x2="330" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="275" y="118" text-anchor="middle" font-size="10" fill="#333">base.nix</text>
    <text x="275" y="133" text-anchor="middle" font-size="10" fill="#333">networking.nix</text>
    <text x="275" y="148" text-anchor="middle" font-size="10" fill="#333">nix-settings.nix</text>

    <!-- hardware/ -->
    <rect x="350" y="80" width="140" height="70" rx="8" ry="8" fill="#d5e8d4" stroke="#82b366"/>
    <text x="420" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">hardware/</text>
    <line x1="360" y1="103" x2="480" y2="103" stroke="#82b366" stroke-width="0.5"/>
    <text x="420" y="118" text-anchor="middle" font-size="10" fill="#333">n100.nix</text>
    <text x="420" y="133" text-anchor="middle" font-size="10" fill="#333">jetson-orin-nano.nix</text>

    <!-- roles/ -->
    <rect x="500" y="80" width="140" height="100" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="570" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">roles/</text>
    <line x1="510" y1="103" x2="630" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="570" y="118" text-anchor="middle" font-size="10" fill="#333">k3s-common.nix</text>
    <text x="570" y="133" text-anchor="middle" font-size="10" fill="#333">k3s-server.nix</text>
    <text x="570" y="148" text-anchor="middle" font-size="10" fill="#333">k3s-agent.nix</text>
    <text x="570" y="163" text-anchor="middle" font-size="9" fill="#888">+secure variants</text>

    <!-- network/ -->
    <rect x="650" y="80" width="120" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="710" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">network/</text>
    <line x1="660" y1="103" x2="760" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="710" y="118" text-anchor="middle" font-size="10" fill="#333">bonding.nix</text>
    <text x="710" y="133" text-anchor="middle" font-size="10" fill="#333">vlans.nix</text>

    <!-- kubernetes/ -->
    <rect x="780" y="80" width="130" height="80" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="845" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">kubernetes/</text>
    <line x1="790" y1="103" x2="900" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="845" y="118" text-anchor="middle" font-size="10" fill="#333">k3s-storage.nix</text>
    <text x="845" y="133" text-anchor="middle" font-size="10" fill="#333">longhorn.nix</text>
    <text x="845" y="148" text-anchor="middle" font-size="10" fill="#333">kyverno.nix</text>

    <!-- security/ -->
    <rect x="920" y="80" width="130" height="60" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="985" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">security/</text>
    <line x1="930" y1="103" x2="1040" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="985" y="118" text-anchor="middle" font-size="10" fill="#333">secrets.nix (SOPS)</text>

    <!-- disko/ -->
    <rect x="1060" y="80" width="130" height="80" rx="8" ry="8" fill="#d5e8d4" stroke="#82b366"/>
    <text x="1125" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">disko/</text>
    <line x1="1070" y1="103" x2="1180" y2="103" stroke="#82b366" stroke-width="0.5"/>
    <text x="1125" y="118" text-anchor="middle" font-size="10" fill="#333">n100-standard.nix</text>
    <text x="1125" y="133" text-anchor="middle" font-size="10" fill="#333">n100-zfs.nix</text>
    <text x="1125" y="148" text-anchor="middle" font-size="10" fill="#333">vm-test.nix</text>

    <!-- vms/ -->
    <rect x="1200" y="80" width="170" height="90" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="1285" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">vms/</text>
    <line x1="1210" y1="103" x2="1360" y2="103" stroke="#6c8ebf" stroke-width="0.5"/>
    <text x="1285" y="118" text-anchor="middle" font-size="10" fill="#333">default.nix</text>
    <text x="1285" y="133" text-anchor="middle" font-size="10" fill="#333">k3s-server-vm.nix</text>
    <text x="1285" y="148" text-anchor="middle" font-size="10" fill="#333">k3s-agent-vm.nix</text>
    <text x="1285" y="163" text-anchor="middle" font-size="10" fill="#333">multi-node-cluster.nix</text>

    <!-- Composition notes -->
    <text x="550" y="205" text-anchor="middle" font-size="10" font-style="italic" fill="#555555">Example: n100-1 = mkSystem { modules = [ hardware/n100 + roles/k3s-server + network/bonding ]; }</text>
    <text x="550" y="225" text-anchor="middle" font-size="10" fill="#6c8ebf">Orthogonal selection: any Hardware × Role × Network combination produces a valid NixOS configuration</text>

    <!-- HOST CONFIGURATIONS Section -->
    <rect x="10" y="245" width="1380" height="80" rx="10" ry="10" fill="#f0f4ff" fill-opacity="0.4" stroke="#6c8ebf" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="263" font-size="13" font-weight="bold" fill="#6c8ebf">HOST CONFIGURATIONS</text>

    <!-- Physical hosts -->
    <rect x="25" y="268" width="120" height="48" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="85" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">n100-1</text>
    <text x="85" y="294" text-anchor="middle" font-size="8" fill="#555">x86_64 | server (init)</text>
    <text x="85" y="306" text-anchor="middle" font-size="8" fill="#555">n100 + bonding</text>

    <rect x="155" y="268" width="120" height="48" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="215" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">n100-2</text>
    <text x="215" y="294" text-anchor="middle" font-size="8" fill="#555">x86_64 | server</text>
    <text x="215" y="306" text-anchor="middle" font-size="8" fill="#555">n100 + bonding</text>

    <rect x="285" y="268" width="120" height="48" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="345" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">n100-3</text>
    <text x="345" y="294" text-anchor="middle" font-size="8" fill="#555">x86_64 | agent</text>
    <text x="345" y="306" text-anchor="middle" font-size="8" fill="#555">n100 + bonding</text>

    <rect x="415" y="268" width="130" height="48" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="480" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">jetson-1</text>
    <text x="480" y="294" text-anchor="middle" font-size="8" fill="#555">aarch64 | agent</text>
    <text x="480" y="306" text-anchor="middle" font-size="8" fill="#555">orin-nano + bonding</text>

    <rect x="555" y="268" width="130" height="48" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="620" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">jetson-2</text>
    <text x="620" y="294" text-anchor="middle" font-size="8" fill="#555">aarch64 | agent</text>
    <text x="620" y="306" text-anchor="middle" font-size="8" fill="#555">orin-nano + bonding</text>

    <!-- VM hosts -->
    <rect x="720" y="268" width="120" height="48" rx="6" ry="6" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="780" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">vm-k3s-server</text>
    <text x="780" y="294" text-anchor="middle" font-size="8" fill="#555">x86_64 | VM</text>
    <text x="780" y="306" text-anchor="middle" font-size="8" fill="#555">standalone test</text>

    <rect x="850" y="268" width="120" height="48" rx="6" ry="6" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="910" y="282" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">vm-k3s-agent</text>
    <text x="910" y="294" text-anchor="middle" font-size="8" fill="#555">x86_64 | VM</text>
    <text x="910" y="306" text-anchor="middle" font-size="8" fill="#555">standalone test</text>

    <!-- Host legend -->
    <text x="1060" y="282" text-anchor="left" font-size="9" font-weight="bold" fill="#82b366">Physical:</text>
    <text x="1120" y="282" text-anchor="left" font-size="9" fill="#555">mkSystem + hosts/ dir + full module stack</text>
    <text x="1060" y="302" text-anchor="left" font-size="9" font-weight="bold" fill="#6c8ebf">VM:</text>
    <text x="1120" y="302" text-anchor="left" font-size="9" fill="#555">mkVMSystem + vms/ modules only</text>

    <!-- NETWORK INTEGRATION Section -->
    <rect x="10" y="340" width="1380" height="170" rx="10" ry="10" fill="#fffaf0" fill-opacity="0.4" stroke="#d6b656" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="360" font-size="13" font-weight="bold" fill="#d6b656">NETWORK INTEGRATION</text>

    <!-- Network Profile -->
    <rect x="25" y="370" width="160" height="120" rx="8" ry="8" fill="#e1d5e7" stroke="#9673a6"/>
    <text x="105" y="388" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">Network Profile</text>
    <line x1="35" y1="393" x2="175" y2="393" stroke="#9673a6" stroke-width="0.5"/>
    <text x="105" y="408" text-anchor="middle" font-size="10" fill="#333">ipAddresses</text>
    <text x="105" y="423" text-anchor="middle" font-size="10" fill="#333">interfaces</text>
    <text x="105" y="438" text-anchor="middle" font-size="10" fill="#333">vlanIds</text>
    <text x="105" y="453" text-anchor="middle" font-size="10" fill="#333">bondConfig</text>
    <text x="105" y="468" text-anchor="middle" font-size="10" fill="#333">serverApi</text>
    <text x="105" y="483" text-anchor="middle" font-size="10" fill="#333">clusterCidr / serviceCidr</text>
    <text x="105" y="498" text-anchor="middle" font-size="9" fill="#9673a6">simple | vlans | bonding-vlans | dhcp-simple</text>

    <!-- Arrow: Profile → mkNixOSConfig -->
    <line x1="185" y1="410" x2="245" y2="410" stroke="#d6b656" stroke-width="2" marker-end="url(#arrowhead-yellow)"/>

    <!-- mkNixOSConfig -->
    <rect x="250" y="375" width="200" height="70" rx="8" ry="8" fill="#fff2cc" stroke="#d6b656"/>
    <text x="350" y="398" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">mkNixOSConfig</text>
    <text x="350" y="413" text-anchor="middle" font-size="9" fill="#555">lib/network/mk-network-config.nix</text>
    <text x="350" y="428" text-anchor="middle" font-size="9" fill="#555">Transforms profile params →</text>
    <text x="350" y="440" text-anchor="middle" font-size="9" fill="#555">NixOS systemd.network modules</text>

    <!-- Arrow: mkNixOSConfig → output -->
    <line x1="450" y1="410" x2="515" y2="410" stroke="#d6b656" stroke-width="2" marker-end="url(#arrowhead-yellow)"/>

    <!-- systemd.network output -->
    <rect x="520" y="375" width="180" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="610" y="398" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">systemd.network.*</text>
    <text x="610" y="413" text-anchor="middle" font-size="9" fill="#555">.netdev units (VLANs, bonds)</text>
    <text x="610" y="428" text-anchor="middle" font-size="9" fill="#555">.network units (addresses, routes)</text>
    <text x="610" y="440" text-anchor="middle" font-size="9" fill="#555">Firewall rules</text>

    <!-- Arrow: Profile → mkK3sFlags -->
    <line x1="185" y1="470" x2="245" y2="478" stroke="#d6b656" stroke-width="2" marker-end="url(#arrowhead-yellow)"/>

    <!-- mkK3sFlags -->
    <rect x="250" y="455" width="200" height="55" rx="8" ry="8" fill="#fff2cc" stroke="#d6b656"/>
    <text x="350" y="475" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">mkK3sFlags</text>
    <text x="350" y="490" text-anchor="middle" font-size="9" fill="#555">lib/k3s/mk-k3s-flags.nix</text>
    <text x="350" y="502" text-anchor="middle" font-size="9" fill="#555">Profile → CLI flags (--node-ip, ...)</text>

    <!-- Arrow: mkK3sFlags → output -->
    <line x1="450" y1="482" x2="515" y2="478" stroke="#d6b656" stroke-width="2" marker-end="url(#arrowhead-yellow)"/>

    <!-- k3s flags output -->
    <rect x="520" y="455" width="180" height="50" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="610" y="475" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">services.k3s.extraFlags</text>
    <text x="610" y="490" text-anchor="middle" font-size="9" fill="#555">Per-node k3s CLI flags</text>
    <text x="610" y="502" text-anchor="middle" font-size="9" fill="#555">injected into NixOS module</text>

    <!-- Cross-backend note -->
    <text x="940" y="422" text-anchor="middle" font-size="9" font-style="italic" fill="#b85450">Same profile data feeds Debian backend via mkSystemdNetworkdFiles (see Debian backend diagram)</text>

    <!-- Debian backend cross-reference box -->
    <rect x="830" y="440" width="160" height="50" rx="8" ry="8" fill="#f8cecc" stroke="#b85450" stroke-dasharray="4 4"/>
    <text x="910" y="458" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">mkSystemdNetworkdFiles</text>
    <text x="910" y="472" text-anchor="middle" font-size="9" fill="#555">→ .network/.netdev files</text>
    <text x="910" y="486" text-anchor="middle" font-size="9" fill="#555">→ Debian backend</text>

    <!-- Dashed arrow from profile to Debian backend -->
    <line x1="185" y1="440" x2="825" y2="465" stroke="#b85450" stroke-width="1" stroke-dasharray="4 4" marker-end="url(#arrowhead-red)"/>

    <!-- nixosTest INTEGRATION Section -->
    <rect x="10" y="525" width="1380" height="175" rx="10" ry="10" fill="#f0f4ff" fill-opacity="0.4" stroke="#6c8ebf" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="548" font-size="13" font-weight="bold" fill="#6c8ebf">nixosTest INTEGRATION</text>

    <!-- mkK3sClusterTest -->
    <rect x="25" y="555" width="200" height="80" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="125" y="575" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">mkK3sClusterTest</text>
    <text x="125" y="590" text-anchor="middle" font-size="9" fill="#555">tests/lib/mk-k3s-cluster-test.nix</text>
    <text x="125" y="605" text-anchor="middle" font-size="9" fill="#555">Parameterized test builder</text>
    <text x="125" y="618" text-anchor="middle" font-size="9" fill="#555">{ networkProfile, useSystemdBoot, ... }</text>

    <!-- Arrow: builder → nodes -->
    <line x1="225" y1="595" x2="285" y2="590" stroke="#6c8ebf" stroke-width="2" marker-end="url(#arrowhead-blue)"/>
    <text x="255" y="583" text-anchor="middle" font-size="8" fill="#6c8ebf">generates</text>

    <!-- Test Node VMs -->
    <rect x="290" y="555" width="200" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="390" y="575" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">Test Node VMs</text>
    <text x="390" y="590" text-anchor="middle" font-size="9" fill="#555">server-1, server-2, agent-1</text>
    <text x="390" y="605" text-anchor="middle" font-size="9" fill="#555">Each: NixOS config + network + k3s</text>
    <text x="390" y="618" text-anchor="middle" font-size="9" fill="#555">Connected via VDE switches</text>

    <!-- Arrow: nodes → driver -->
    <line x1="490" y1="590" x2="550" y2="590" stroke="#6c8ebf" stroke-width="2" marker-end="url(#arrowhead-blue)"/>
    <text x="520" y="583" text-anchor="middle" font-size="8" fill="#6c8ebf">run by</text>

    <!-- NixOS Test Driver -->
    <rect x="555" y="555" width="210" height="70" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf" stroke-width="2"/>
    <text x="660" y="575" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">NixOS Test Driver</text>
    <text x="660" y="590" text-anchor="middle" font-size="9" fill="#555">Python test script + QEMU VMs</text>
    <text x="660" y="605" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">Build + Test = ONE derivation</text>
    <text x="660" y="618" text-anchor="middle" font-size="9" fill="#555">(no separate build/test phases)</text>

    <!-- Arrow: driver → result -->
    <line x1="765" y1="590" x2="825" y2="588" stroke="#82b366" stroke-width="2" marker-end="url(#arrowhead-green)"/>
    <text x="795" y="583" text-anchor="middle" font-size="8" fill="#82b366">produces</text>

    <!-- PASS/FAIL -->
    <rect x="830" y="560" width="120" height="55" rx="8" ry="8" fill="#d5e8d4" stroke="#82b366"/>
    <text x="890" y="582" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">PASS / FAIL</text>
    <text x="890" y="597" text-anchor="middle" font-size="9" fill="#555">Test log + result</text>
    <text x="890" y="610" text-anchor="middle" font-size="9" fill="#555">in /nix/store/...</text>

    <!-- Key difference note -->
    <text x="35" y="654" font-size="9" fill="#b85450" font-weight="bold">Key difference from Debian backend:</text>
    <text x="200" y="654" font-size="9" fill="#b85450">NixOS test derivation = build + test in one step. Debian backend requires separate .wic build → hash registration → test derivation.</text>
    <text x="35" y="672" font-size="9" fill="#555555" font-weight="bold">Test Matrix:</text>
    <text x="115" y="672" font-size="9" fill="#555555">Profile (4) × Boot (2) = 8 NixOS cluster tests + smoke tests (L1-L3) + specialized tests</text>

    <!-- Shared with Debian backend box -->
    <rect x="1010" y="555" width="170" height="65" rx="8" ry="8" fill="#f8cecc" stroke="#b85450" stroke-dasharray="4 4"/>
    <text x="1095" y="575" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">Shared with Debian backend:</text>
    <text x="1095" y="590" text-anchor="middle" font-size="9" fill="#555">Debian tests also use NixOS test</text>
    <text x="1095" y="605" text-anchor="middle" font-size="9" fill="#555">driver + QEMU, but boot .wic</text>
    <text x="1095" y="618" text-anchor="middle" font-size="9" fill="#555">images instead of NixOS configs</text>

    <!-- DEPLOYMENT PATHS Section -->
    <rect x="10" y="715" width="1380" height="125" rx="10" ry="10" fill="#f5f5f5" fill-opacity="0.4" stroke="#999999" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="735" font-size="13" font-weight="bold" fill="#999999">DEPLOYMENT PATHS</text>

    <!-- nixosConfiguration source -->
    <rect x="25" y="745" width="140" height="55" rx="8" ry="8" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="95" y="765" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">nixosConfiguration</text>
    <text x="95" y="780" text-anchor="middle" font-size="9" fill="#555">Evaluated NixOS</text>
    <text x="95" y="792" text-anchor="middle" font-size="9" fill="#555">system closure</text>

    <!-- Deploy arrows and targets -->
    <line x1="165" y1="765" x2="225" y2="762" stroke="#999" stroke-width="1" marker-end="url(#arrowhead-gray)"/>
    <rect x="230" y="740" width="150" height="55" rx="8" ry="8" fill="#f5f5f5" stroke="#999"/>
    <text x="305" y="760" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">nixos-rebuild</text>
    <text x="305" y="775" text-anchor="middle" font-size="9" fill="#555">switch --flake .#host</text>
    <text x="305" y="788" text-anchor="middle" font-size="9" fill="#555">In-place upgrade</text>

    <line x1="165" y1="772" x2="435" y2="767" stroke="#999" stroke-width="1" marker-end="url(#arrowhead-gray)"/>
    <rect x="440" y="740" width="165" height="55" rx="8" ry="8" fill="#f5f5f5" stroke="#999"/>
    <text x="522" y="760" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">nixos-anywhere</text>
    <text x="522" y="775" text-anchor="middle" font-size="9" fill="#555">First install: bare metal</text>
    <text x="522" y="788" text-anchor="middle" font-size="9" fill="#555">Disk partitioning via disko</text>

    <line x1="165" y1="778" x2="655" y2="767" stroke="#999" stroke-width="1" marker-end="url(#arrowhead-gray)"/>
    <rect x="660" y="740" width="155" height="55" rx="8" ry="8" fill="#d5e8d4" stroke="#82b366"/>
    <text x="737" y="760" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">jetpack-nixos</text>
    <text x="737" y="775" text-anchor="middle" font-size="9" fill="#555">Jetson flash via initrd</text>
    <text x="737" y="788" text-anchor="middle" font-size="9" fill="#555">NVIDIA BSP + NixOS rootfs</text>

    <line x1="165" y1="782" x2="865" y2="767" stroke="#999" stroke-width="1" marker-end="url(#arrowhead-gray)"/>
    <rect x="870" y="740" width="140" height="55" rx="8" ry="8" fill="#f5f5f5" stroke="#999"/>
    <text x="940" y="760" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">VM Image</text>
    <text x="940" y="775" text-anchor="middle" font-size="9" fill="#555">system.build.vm</text>
    <text x="940" y="788" text-anchor="middle" font-size="9" fill="#555">Standalone QEMU VM</text>

    <line x1="165" y1="785" x2="1055" y2="767" stroke="#999" stroke-width="1" marker-end="url(#arrowhead-gray)"/>
    <rect x="1060" y="740" width="155" height="55" rx="8" ry="8" fill="#f5f5f5" stroke="#999"/>
    <text x="1137" y="760" text-anchor="middle" font-size="10" font-weight="bold" fill="#333">Amazon AMI</text>
    <text x="1137" y="775" text-anchor="middle" font-size="9" fill="#555">system.build.images.amazon</text>
    <text x="1137" y="788" text-anchor="middle" font-size="9" fill="#555">CI runners (infra flake)</text>

    <text x="550" y="822" text-anchor="middle" font-size="9" fill="#555555">Targets: Intel N100 (x86_64) | Jetson Orin Nano (aarch64) | EC2 instances (infra flake) | Local VMs</text>

    <!-- FLAKE INPUTS Section -->
    <rect x="10" y="855" width="1380" height="100" rx="10" ry="10" fill="#f5f5f5" fill-opacity="0.4" stroke="#999999" stroke-width="2" stroke-dasharray="8 8"/>
    <text x="30" y="875" font-size="13" font-weight="bold" fill="#999999">FLAKE INPUTS</text>

    <!-- Input boxes -->
    <rect x="25" y="882" width="140" height="50" rx="6" ry="6" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="95" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">nixpkgs</text>
    <text x="95" y="913" text-anchor="middle" font-size="8" fill="#555">nixos-25.11 (fork)</text>
    <text x="95" y="925" text-anchor="middle" font-size="8" fill="#555">bootDiskAdditionalSpace</text>

    <rect x="175" y="882" width="120" height="50" rx="6" ry="6" fill="#f5f5f5" stroke="#999"/>
    <text x="235" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">disko</text>
    <text x="235" y="913" text-anchor="middle" font-size="8" fill="#555">Declarative disk</text>
    <text x="235" y="925" text-anchor="middle" font-size="8" fill="#555">partitioning</text>

    <rect x="305" y="882" width="120" height="50" rx="6" ry="6" fill="#f5f5f5" stroke="#999"/>
    <text x="365" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">sops-nix</text>
    <text x="365" y="913" text-anchor="middle" font-size="8" fill="#555">Secrets management</text>
    <text x="365" y="925" text-anchor="middle" font-size="8" fill="#555">age + SOPS</text>

    <rect x="435" y="882" width="130" height="50" rx="6" ry="6" fill="#d5e8d4" stroke="#82b366"/>
    <text x="500" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">jetpack-nixos</text>
    <text x="500" y="913" text-anchor="middle" font-size="8" fill="#555">Jetson support (fork)</text>
    <text x="500" y="925" text-anchor="middle" font-size="8" fill="#555">pluggable-rootfs</text>

    <rect x="575" y="882" width="140" height="50" rx="6" ry="6" fill="#f5f5f5" stroke="#999"/>
    <text x="645" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">nixos-anywhere</text>
    <text x="645" y="913" text-anchor="middle" font-size="8" fill="#555">Bare-metal provisioning</text>
    <text x="645" y="925" text-anchor="middle" font-size="8" fill="#555">SSH + kexec + disko</text>

    <rect x="725" y="882" width="140" height="50" rx="6" ry="6" fill="#f5f5f5" stroke="#999"/>
    <text x="795" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">nixos-hardware</text>
    <text x="795" y="913" text-anchor="middle" font-size="8" fill="#555">Hardware profiles</text>
    <text x="795" y="925" text-anchor="middle" font-size="8" fill="#555">community maintained</text>

    <rect x="875" y="882" width="130" height="50" rx="6" ry="6" fill="#f5f5f5" stroke="#999" stroke-dasharray="4 4"/>
    <text x="940" y="900" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">impermanence</text>
    <text x="940" y="913" text-anchor="middle" font-size="8" fill="#555">Stateless root</text>
    <text x="940" y="925" text-anchor="middle" font-size="8" fill="#555">(optional, unused)</text>

    <text x="1030" y="900" font-size="9" font-style="italic" fill="#555">Fork inputs (nixpkgs, jetpack-nixos)</text>
    <text x="1030" y="915" font-size="9" font-style="italic" fill="#555">have upstream PRs pending.</text>
    <text x="1030" y="930" font-size="9" font-style="italic" fill="#555">Revert to official when merged.</text>

    <!-- Legend -->
    <text x="25" y="980" font-size="10" font-weight="bold" fill="#333">Legend:</text>

    <rect x="80" y="968" width="80" height="22" rx="4" ry="4" fill="#dae8fc" stroke="#6c8ebf"/>
    <text x="120" y="983" text-anchor="middle" font-size="9" fill="#333">Nix/NixOS</text>

    <rect x="170" y="968" width="80" height="22" rx="4" ry="4" fill="#d5e8d4" stroke="#82b366"/>
    <text x="210" y="983" text-anchor="middle" font-size="9" fill="#333">Hardware</text>

    <rect x="260" y="968" width="80" height="22" rx="4" ry="4" fill="#fff2cc" stroke="#d6b656"/>
    <text x="300" y="983" text-anchor="middle" font-size="9" fill="#333">Generators</text>

    <rect x="350" y="968" width="85" height="22" rx="4" ry="4" fill="#e1d5e7" stroke="#9673a6"/>
    <text x="392" y="983" text-anchor="middle" font-size="9" fill="#333">Shared Data</text>

    <rect x="445" y="968" width="95" height="22" rx="4" ry="4" fill="#f8cecc" stroke="#b85450"/>
    <text x="492" y="983" text-anchor="middle" font-size="9" fill="#333">Cross-backend</text>

    <rect x="550" y="968" width="85" height="22" rx="4" ry="4" fill="#f5f5f5" stroke="#999"/>
    <text x="592" y="983" text-anchor="middle" font-size="9" fill="#333">Deploy/Infra</text>

    <!-- Cross-references -->
    <text x="700" y="1010" text-anchor="middle" font-size="9" fill="#666">See also: n3x-architecture.drawio.svg (system overview), n3x-debian-backend.drawio.svg (Debian backend), ci-pipeline.drawio.svg (CI/CD)</text>

    <!-- Arrowhead definitions -->
    <defs>
      <marker id="arrowhead-yellow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#d6b656"/>
      </marker>
      <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#6c8ebf"/>
      </marker>
      <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#82b366"/>
      </marker>
      <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#b85450"/>
      </marker>
      <marker id="arrowhead-gray" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#999"/>
      </marker>
    </defs>
  </g>
</svg>
