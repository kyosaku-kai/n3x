# isar-k3s-base
# isar-k3s common configuration
DISTRO_APT_PREMIRRORS = ""

# isar-k3s-compression
# Use pigz for parallel gzip compression (significantly faster on multi-core)
# This replaces single-threaded gzip in CONVERSION_CMD:gz
# Requires pigz to be installed in the build environment
CONVERSION_DEPS:gz = "pigz"
CONVERSION_CMD:gz = "${SUDO_CHROOT} sh -c 'pigz -f -9 -n -c -k ${IMAGE_FILE_CHROOT} > ${IMAGE_FILE_CHROOT}.gz'"

# Use parallel xz compression (xz supports -T for threads)
XZ_DEFAULTS ?= "-T 0"

# Use parallel zstd compression (zstd supports -T for threads)
ZSTD_DEFAULTS ?= "-T0 -19"

# isar-k3s-parallelism
# Parallelism settings to PREVENT SWAPPING
# Goal: Keep peak memory under 24GB (28GB system - 4GB headroom)
#
# BB_NUMBER_THREADS: concurrent BitBake tasks (recipe-level parallelism)
# Heavy tasks (kernel compile, linking) can use 2-4GB each
# 24GB / ~3GB avg = 8 concurrent heavy tasks max
BB_NUMBER_THREADS = "8"

# PARALLEL_MAKE: -j flag for make (within-recipe parallelism)
# Keep at full CPU count - memory is limited by BB_NUMBER_THREADS
# PARALLEL_MAKE defaults to -j20 (auto-detected)

# BB_PRESSURE_MAX_MEMORY: Backup throttle if pressure rises despite limits
# Value is microseconds of stall per second (10000 = 1% threshold)
# Reacts early before OOM killer intervenes
BB_PRESSURE_MAX_MEMORY = "10000"

# network-simple
# Simple network profile - single flat network on eth1
# Uses systemd-networkd config files generated from Nix profiles
IMAGE_INSTALL:append = " systemd-networkd-config"
NETWORKD_PROFILE = "simple"
# NETWORKD_NODE_NAME set by kas/node/*.yml overlay

# node-identity
# Node identity for systemd-networkd-config
NETWORKD_NODE_NAME = "server-1"

# shared-cache
# Shared user-level cache directories for all Yocto/ISAR projects
# This enables cache reuse across multiple projects/builds
# BitBake auto-creates these directories if they don't exist
DL_DIR = "${HOME}/.cache/yocto/downloads"
SSTATE_DIR = "${HOME}/.cache/yocto/sstate"

# test-k3s-config
# Include NixOS test driver backdoor service
# This enables VM testing with nixos-test-driver
IMAGE_INSTALL:append = " nixos-test-backdoor"

MACHINE ??= "qemuamd64"
DISTRO ??= "debian-trixie"
BBMULTICONFIG ?= ""
