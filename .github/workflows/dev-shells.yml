# Validate the default dev shell on all claimed platforms.
#
# Tests that `nix develop` enters, key tools are on PATH, shellHook
# runs without error, and tools are functional. Lightweight (eval + fetch,
# no builds).
#
# Platform coverage:
#   - Ubuntu 24.04 (x86_64-linux): full validation including shellHook
#   - macOS latest (aarch64-darwin): shell entry + tools. No Docker on
#     GH runners, so shellHook warns about missing Docker â€” expected.

name: Dev Shell

on:
  push:
    paths:
      - 'flake.nix'
      - 'flake.lock'
      - 'backends/debian/kas/**'
  pull_request:
    paths:
      - 'flake.nix'
      - 'flake.lock'
      - 'backends/debian/kas/**'
  workflow_dispatch:

concurrency:
  group: dev-shell-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: "dev shell (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Enter shell
        run: |
          nix develop --command bash -c 'echo "shell-entry: OK"'

      - name: Validate tools on PATH
        run: |
          nix develop --command bash -c '
            FAIL=0
            for tool in kas jq yq kas-build kas-container; do
              if command -v "$tool" &>/dev/null; then
                printf "  %-25s %s\n" "$tool" "$(command -v "$tool")"
              else
                printf "  %-25s %s\n" "$tool" "MISSING"
                FAIL=1
              fi
            done
            exit $FAIL
          '

      - name: Validate tool functionality
        run: |
          nix develop --command bash -c '
            echo "--- kas ---"
            kas --version

            echo ""
            echo "--- kas-build ---"
            kas-build --help | head -5
          '
