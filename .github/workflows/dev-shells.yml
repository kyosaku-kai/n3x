# Validate the default dev shell on all claimed platforms.
#
# Tests that `nix develop` enters, key tools are on PATH, shellHook
# runs without error, and tools are functional. Lightweight (eval + fetch,
# no builds).
#
# Platform coverage:
#   - Ubuntu 24.04 (x86_64-linux): full validation — Docker present on
#     runner, so shellHook passes and shell entry succeeds.
#   - macOS latest (aarch64-darwin): verifies hard-fail behavior — no
#     Docker on GH runners, so shellHook correctly rejects shell entry
#     with actionable error message (T1d hard-fail validation).

name: Dev Shell

on:
  push:
    paths:
      - 'flake.nix'
      - 'flake.lock'
      - 'backends/debian/kas/**'
  pull_request:
    paths:
      - 'flake.nix'
      - 'flake.lock'
      - 'backends/debian/kas/**'
  workflow_dispatch:

concurrency:
  group: dev-shell-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: "dev shell (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - uses: DeterminateSystems/magic-nix-cache-action@main

      # Linux: full validation (Docker present on ubuntu-24.04)
      - name: Enter shell
        if: runner.os == 'Linux'
        run: |
          nix develop --command bash -c 'echo "shell-entry: OK"'

      - name: Validate tools on PATH
        if: runner.os == 'Linux'
        run: |
          nix develop --command bash -c '
            FAIL=0
            for tool in kas jq yq kas-build kas-container; do
              if command -v "$tool" &>/dev/null; then
                printf "  %-25s %s\n" "$tool" "$(command -v "$tool")"
              else
                printf "  %-25s %s\n" "$tool" "MISSING"
                FAIL=1
              fi
            done
            exit $FAIL
          '

      - name: Validate tool functionality
        if: runner.os == 'Linux'
        run: |
          nix develop --command bash -c '
            echo "--- kas ---"
            kas --version

            echo ""
            echo "--- kas-build ---"
            kas-build --help | head -5
          '

      # macOS: verify hard-fail behavior (no Docker on GH runners)
      - name: Verify shell rejects missing Docker
        if: runner.os == 'macOS'
        run: |
          OUTPUT=$(nix develop --command bash -c 'echo OK' 2>&1) && {
            echo "ERROR: Shell should have rejected entry without Docker"
            exit 1
          }
          echo "Shell correctly rejected entry (exit code: $?)"
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "Docker not found"; then
            echo "PASS: Error message contains expected 'Docker not found'"
          else
            echo "FAIL: Expected 'Docker not found' in output"
            exit 1
          fi
