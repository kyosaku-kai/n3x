# K3s Test Overlay - k3s server with NixOS test driver backdoor
# =============================================================================
#
# PURPOSE:
#   Builds a k3s server image with the nixos-test-backdoor for VM testing.
#   Combines test-overlay.yml with k3s-server.yml for test parity with n3x.
#
# USAGE:
#   kas-container --isar build kas/base.yml:kas/machine/qemu-amd64.yml:kas/test-k3s-overlay.yml
#
# NOTES:
#   - Includes k3s-server package (control plane)
#   - Includes nixos-test-backdoor for test driver communication
#   - Safe for automated testing only - NOT for production
#
# =============================================================================

header:
  version: 14

# Build the k3s server image
target: isar-k3s-image-server

local_conf_header:
  test-k3s-config: |
    # Include NixOS test driver backdoor service
    # This enables VM testing with nixos-test-driver
    IMAGE_INSTALL:append = " nixos-test-backdoor"
