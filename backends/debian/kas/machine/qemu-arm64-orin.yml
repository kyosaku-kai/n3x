# QEMU ARM64 machine configuration - Orin Nano emulation profile
#
# Purpose: Emulate Jetson Orin Nano platform as closely as possible in QEMU
# Usage: kas-container --isar build kas/base.yml:kas/machine/qemu-arm64-orin.yml
#
# Emulation notes:
# - Uses 'virt' machine type with Device Tree (no ACPI)
# - Cortex-A78 CPU (closest to Orin's Cortex-A78AE cores)
# - UEFI boot via AAVMF firmware
# - Standard serial console (ttyAMA0) for simplicity
# - No GPU emulation (matches our headless use case)
#
# Limitations vs real Orin:
# - No Tegra234-specific peripherals (SDMMC, UFS, etc.)
# - Different device tree structure
# - No NVIDIA L4T packages (those target real HW)
#
# QEMU launch command:
#   qemu-system-aarch64 -machine virt -cpu cortex-a78 -m 4G -smp 4 -nographic \
#     -drive if=pflash,format=raw,readonly=on,file=AAVMF_CODE.fd \
#     -drive if=pflash,format=raw,file=AAVMF_VARS.fd \
#     -drive file=<image>.wic,format=raw,if=virtio \
#     -serial mon:stdio
#
# Or simpler with -bios:
#   qemu-system-aarch64 -machine virt -cpu cortex-a78 -m 4G -smp 4 -nographic \
#     -bios AAVMF.fd \
#     -drive file=<image>.wic,format=raw \
#     -serial mon:stdio
#
# Note: Requires binfmt_misc configured for QEMU user-mode emulation during build

header:
  version: 14
  includes:
    - ../base.yml

machine: qemuarm64
distro: debian-trixie

# Isar multiconfig target format: mc:{machine}-{distro_short}:{image}
target: mc:qemuarm64-trixie:isar-image-base

local_conf_header:
  qemu-orin-emu: |
    # Orin Nano emulation profile
    # Cross-compilation enabled (default). Uses host cross-toolchain for
    # compilation, avoiding ~10-20x QEMU TCG emulation overhead.

    # UEFI boot with GPT partitioning (same as real Orin)
    # .wic.bmap is generated automatically by ISAR's WIC builder (--bmap flag)
    IMAGE_FSTYPES = "wic wic.zst"
    # ARM64 WKS: Use systemd-boot (recipe default) instead of ISAR's
    # built-in sdimage-efi which uses grub-efi (requires grub-mkimage,
    # x86-only). No WKS_FILE override needed; n3x-image-base.bb defaults
    # to sdimage-efi-systemd-boot-n3x.wks which works for both x86 and ARM64.

    # Serial console on ttyAMA0 (standard QEMU ARM serial)
    # Real Orin uses ttyTCU0 (Tegra Combined UART), but ttyAMA0 is simpler
    MACHINE_SERIAL = "ttyAMA0"
    BAUDRATE_TTY = "115200"

    # Note: L4T packages are NOT included here - they target real Tegra hardware
    # This emulation profile tests the base Debian system and K3s functionality
