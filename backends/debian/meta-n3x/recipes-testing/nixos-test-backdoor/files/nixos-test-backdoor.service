[Unit]
Description=NixOS Test Driver Backdoor Shell
Documentation=https://nixos.org/manual/nixos/stable/#sec-nixos-tests

# Start early - after basic system is up but before user services
DefaultDependencies=no
After=systemd-journald.socket
After=systemd-udev-settle.service
After=dev-hvc0.device
After=dev-ttyS0.device
Before=multi-user.target

# Conflict with getty services - we need exclusive access to hvc0
# Without this, getty can write login prompts to hvc0 and corrupt
# the test driver's base64-encoded shell protocol
Conflicts=serial-getty@hvc0.service serial-getty@ttyS0.service
Conflicts=getty@hvc0.service getty@ttyS0.service

# Only start if virtio-console device exists (i.e., running under test driver)
ConditionPathExists=/dev/hvc0

[Service]
Type=simple
ExecStart=/usr/lib/nixos-test/backdoor.sh
StandardInput=null
StandardOutput=null
StandardError=null

# Run as root for full system access
User=root
Group=root

# Keep trying if it fails
Restart=on-failure
RestartSec=1

[Install]
WantedBy=multi-user.target
